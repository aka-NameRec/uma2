# –î–∏–∑–∞–π–Ω –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å—É—â–Ω–æ—Å—Ç–µ–π
_Exported on 04.01.2026 at 14:29:16 GMT+3 from Cursor (2.3.21)_

---

**User**

(20260103-132214) (20260103-144530) (20260103-162928)
(1) –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–∑–Ω–∞–∫–æ–º—å—Å—è —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –∫–∞—Ç–∞–ª–æ–≥–∞ `docs`, –∏–∑—É—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ.

(2) –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è –æ–±—Å—É–¥–∏—Ç—å —Ç–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å—É—â–Ω–æ—Å—Ç–µ–π.

(3) –ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö –∏—Å–∫–∞–∂–µ–Ω–∏–π, —è –±—É–¥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ `eh` –æ—Ç "Entity Handlers" –ø—Ä–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω–æ –∫ –∫–ª–∞—Å—Å–∞–º, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞ UMA (select, CRUD, meta) –≤–º–µ—Å—Ç–æ —Ä–∞–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π `entity`.
–¢–µ—Ä–º–∏–Ω –∂–µ `entity` —è –±—É–¥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω–æ –∫ –æ–±—ä–µ–∫—Ç–∞–º –ë–î (—Ç–∞–±–ª–∏—Ü—ã, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è).
–¢–∞–∫–∂–µ —è –±—É–¥—É –≥–æ–≤–æ—Ä–∏—Ç—å –æ *–≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–∏*, –∫–æ–≥–¥–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —ç–º—É–ª–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ UMA, –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –≤ UMA-–∑–∞–ø—Ä–æ—Å–∞—Ö –∫–∞–∫ –æ–±—ã—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞. 

(4) –í —Å–≤–µ—Ç–µ —Ç–≤–æ–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –≤ `docs/20260103-130403-log-impl_proposal.md` —è —Ä–µ—à–∏–ª —Å–µ–π—á–∞—Å —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è –Ω–∞ —Ç–µ–º–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –ø–æ—Å–∫–æ–ª—å–∫—É –ø–æ–∑–∂–µ —ç—Ç–æ –±—É–¥–µ—Ç –Ω–µ–ø—Ä–æ—Å—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å.

(5) –ò—Ç–∞–∫, –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ–∑–∏—Å–æ–≤ –≤ —ç—Ç–æ–π —Å–≤—è–∑–∏:

(.1) (`entity_name`) –ö–ª—é—á–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —è–≤–ª—è–µ—Ç—Å—è –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏.

(.2) –ú–Ω–µ —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ø–æ—Å–æ–±, –∞–ª–≥–æ—Ä–∏—Ç–º (–ø–æ–ª—É—á–µ–Ω–∏—è –≤—ã–±–æ—Ä–∫–∏, –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è CRUD, –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö), —É –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è, –∞ –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è –µ–≥–æ (—Å–ø–æ—Å–æ–±–∞, –∞–ª–≥–æ—Ä–∏—Ç–º–∞) —Ä–∞–±–æ—Ç—ã –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (select, CRUD, meta).

(.3) –ü–æ—Å–∫–æ–ª—å–∫—É —Ä–µ—á—å –∏–¥—ë—Ç –æ —Å–ø–æ—Å–æ–±–µ, —Ç–æ —Å–ø–æ—Å–æ–± (–∞–ª–≥–æ—Ä–∏—Ç–º) –Ω–µ –æ–±—è–∑–∞–Ω –±—ã—Ç—å –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∏–º–µ–Ω–∏ —Å—É—â–Ω–æ—Å—Ç–∏ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ–º one-to-one ‚Äì –∑–¥–µ—Å—å –∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ one-to-many: –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Å–ø–æ—Å–æ–± –æ–±—Ä–∞–±–æ—Ç–∫–∏ UMA-–æ–ø–µ—Ä–∞—Ü–∏–π –º–æ–∂–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤—É —Å—É—â–Ω–æ—Å—Ç–µ–π, –∫–∞–∫ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –±—É–¥–µ—Ç —Å –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ–º —Ç–∞–±–ª–∏—Ü—ã –ë–î ‚Äì –∏—Ö –±—É–¥–µ—Ç –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å Entity Handler –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é.
–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ Entity Handler —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –Ω–µ –¥–æ–ª–∂–Ω—ã. –ù–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–¥–∞—á—É –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ –∏–º–µ–Ω–∏ —Å—É—â–Ω–æ—Å—Ç–∏ (—Å–º. –Ω–∏–∂–µ).
–ò—Å–∫–ª—é—á–µ–Ω–∏–µ–º –∑–¥–µ—Å—å –±—É–¥—É—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è, —É –∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –±—É–¥–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–π `select`, –∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —É–¥–æ–±–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–æ–ª—è—Ö –∫–ª–∞—Å—Å–∞, –ø–æ—Å–∫–æ–ª—å–∫—É SQLAlchemy –∏ –°–£–ë–î –æ –Ω–∏—Ö –Ω–∏—á–µ–≥–æ "–Ω–µ –∑–Ω–∞–µ—Ç". 

(.4) –≠–ª–µ–º–µ–Ω—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚Äì –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—É—â–Ω–æ—Å—Ç–∏ —è –ø—Ä–µ–¥–ª–∞–≥–∞—é –æ–±–æ–∑–Ω–∞—á–∞—Ç—å `eh`, –≥–æ–≤–æ—Ä–∏–ª –æ –Ω—ë–º –≤—ã—à–µ.

(.5) –ú—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—É–¥–µ–º —Å–æ–∑–¥–∞–≤–∞—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä—ã `eh`, –º—ã –±—É–¥–µ–º —á–µ—Ä–µ–∑ –º–µ—Ö–∞–Ω–∏–∑–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—É—á–∞—Ç—å –ø–æ –∏–º–µ–Ω–∏ —Å—É—â–Ω–æ—Å—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–ª–∞—Å—Å-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –∏ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –µ–≥–æ –º–µ—Ç–æ–¥–∞–º, –ø–µ—Ä–µ–¥–∞–≤–∞—è –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏ –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞, –≤ —Å–ª—É—á–∞–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

(.6) –ú–µ—Ö–∞–Ω–∏–∑–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `eh` –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏:
1) –¥–ª—è –∏–º–µ–Ω–∏ —Å—É—â–Ω–æ—Å—Ç–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —ç–ª–µ–º–µ–Ω—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚Äì –Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —É —Å—É—â–Ω–æ—Å—Ç–∏ –Ω–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏
2) —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è `entity` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äì –≤ –ë–î –µ—Å—Ç—å —Ç–∞–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞.

(.7) –î–ª—è –º–µ—Ö–∞–Ω–∏–∑–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω —Å–ø–æ—Å–æ–± —É–∫–∞–∑–∞–Ω–∏—è `eh` –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é.
–ö–∞–∫ –ø—Ä–∞–≤–∏–ª–æ, –≤ –ø—Ä–æ–µ–∫—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É—é—â–µ–º UMA –º–æ–∂–µ—Ç –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å—Å—è –∫–ª–∞—Å—Å-–ø–æ—Ç–æ–º–æ–∫ –æ—Ç `eh` –ø–æ-–º–æ–ª—á–∞–Ω–∏—é, —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ—Ç–æ—Ä–æ–≥–æ —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –≤ UMA. 

(6) –ö–æ–Ω—Ç–µ–∫—Å—Ç UMA-–æ–ø–µ—Ä–∞—Ü–∏–π –≤ `eh`.

(.1) `select`: –Ω—É–∂–Ω—ã –∏–º—è —Ç–∞–±–ª–∏—Ü—ã, –∏ –¥–æ—Å—Ç—É–ø –∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∑–∞–ø—Ä–æ—Å–∞ ‚Äì —ç—Ç–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π.

(.2) CRUD-–æ–ø–µ—Ä–∞—Ü–∏–∏: –∏–º—è —Ç–∞–±–ª–∏—Ü—ã, —Å–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è `save`, –∏–ª–∏ `id` –¥–ª—è `read` –∏ `delete`.

(.3) `meta`: –∏–º—è —Ç–∞–±–ª–∏—Ü—ã. –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ `eh` ‚Äì —ç—Ç–æ –º–æ–∂–Ω–æ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ ‚Äì –¥–∞ –≤ —Ç–æ–º –∂–µ Redis, —Ö–æ—Ç—è —Å–µ–π—á–∞—Å –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –º–æ–∂–Ω–æ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.
–í–∞—Ä–∏–∞–Ω—Ç —Å Redis –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω —Ç–µ–º. —á—Ç–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç —Ä–∞–∑–¥–µ–ª—è—Ç—å—Å—è –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞–º–∏ —Å–µ—Ä–≤–∏—Å–∞, –∏—Å–ø–æ–ª—å–∑—É—é—â–µ–≥–æ UMA.

(7) –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ.
–û—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö ‚Äì SQAlchemy. –í –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –±—É–¥—É—Ç –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞—Ç—å —Å–≤–µ–¥–µ–Ω–∏—è –æ –ø–æ–ª—è—Ö —Ç–∞–±–ª–∏—Ü—ã/–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è, –∏—Ö —Ç–∏–ø–µ, —Ä–∞–∑–º–µ—Ä–µ, –∞ —Ç–∞–∫–∂–µ (–æ—á–µ–Ω—å –≤–∞–∂–Ω–æ) —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤–Ω–µ—à–Ω–µ–≥–æ –∫–ª—é—á–∞: –Ω–∞ –∫–∞–∫—É—é —Ç–∞–±–ª–∏—Ü—É/–ø–æ–ª–µ —ç—Ç–æ—Ç –∫–ª—é—á –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω.
–¢–∞–∫–∂–µ –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ m2m-–ø–æ–ª—è—Ö (many-to-many), –ø–æ—Å–∫–æ–ª—å–∫—É —ç—Ç–æ –≤–∞–∂–Ω–æ –Ω–∞ frontend –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —Å–ø–æ—Å–æ–±–∞ –≤–≤–æ–¥–∞ –∑–Ω–∞—á–µ–Ω–∏–π —Ç–∞–∫–∏—Ö –ø–æ–ª–µ–π.

(8) –¢–µ–∑–∏—Å—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—ã–±–æ—Ä–∫—É.
1) –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏ (`entity_name`) –∏–∑ –±–ª–æ–∫–∞ `FROM`.
2) –ù–∞—Ö–æ–¥–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞—é—â–∏–π —ç—Ç—É —Å—É—â–Ω–æ—Å—Ç—å Entity Handler (`eh`).
3) –í—ã–∑—ã–≤–∞–µ–º `eh.select`, –∫—É–¥–∞ —Ç–∞–∫ –∏–ª–∏ –∏–Ω–∞—á–µ –ø–µ—Ä–µ–¥–∞—ë–º –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ª—É—á–∞–µ–º –∑–∞–ø—Ä–æ—Å (`query`).
4) –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø–ø. 2, 3 –ø–æ—Å—Ç—É–ø–∞–µ–º –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏–∏ –∏–º—ë–Ω —Å—É—â–Ω–æ—Å—Ç–µ–π, —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –≤  `JSON`.
5) –£—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ —Å—É—â–Ω–æ—Å—Ç—å –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º, –∏ –º–æ–∂–µ—Ç –Ω–µ–æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –∑–∞–ø—Ä–æ—Å–µ (–ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã –∏ `JOIN`) ‚Äì –ø–æ—ç—Ç–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç `select` –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –≤—Å–µ–≥–¥–∞ –æ—Ñ–æ—Ä–º–ª—è–µ—Ç—Å—è –∫–∞–∫ CTE –≤ —Ñ–æ—Ä–º–∏—Ä—É–µ–º–æ–º –∑–∞–ø—Ä–æ—Å–µ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è.
‚Äî

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ü–µ–Ω–∏ –∏–¥–µ—é, –ø–æ–¥—Å–≤–µ—Ç–∏ —Ä–∏—Å–∫–∏ –∏, –µ—Å–ª–∏ –Ω–µ—Ç –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π ‚Äì –ø—Ä–µ–¥–ª–æ–∂–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é.


---

**Cursor**

–î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω—ë–º —Å –∏–∑—É—á–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ `docs`, –∞ –∑–∞—Ç–µ–º –æ–±—Å—É–¥–∏–º –≤–∞—à—É –∫–æ–Ω—Ü–µ–ø—Ü–∏—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å—É—â–Ω–æ—Å—Ç–µ–π.

–ò–∑—É—á–∏–ª –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é. –í–∏–∂—É —ç–≤–æ–ª—é—Ü–∏—é –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –æ—Ç entity –∫–∞–∫ –∫–ª–∞—Å—Å–æ–≤ —Å —ç–∫–∑–µ–º–ø–ª—è—Ä–∞–º–∏ –∫ **entity handlers (eh)** –∫–∞–∫ stateless –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤. –≠—Ç–æ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–∞. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—É—é –∫–æ–Ω—Ü–µ–ø—Ü–∏—é.

## üìä –û—Ü–µ–Ω–∫–∞ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ Entity Handlers (eh)

### ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã

1. **Stateless –ø–æ–¥—Ö–æ–¥**: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ `eh` —É–ø—Ä–æ—â–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º, –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.

2. **One-to-many –º–∞–ø–ø–∏–Ω–≥**: –û–¥–∏–Ω `eh` –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å—É—â–Ω–æ—Å—Ç–µ–π ‚Äî —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ, —É–º–µ–Ω—å—à–∞—é—â–µ–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–¥–∏–Ω `DefaultTableHandler` –¥–ª—è –≤—Å–µ—Ö –æ–±—ã—á–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü).

3. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–æ–≤**: `eh` (–æ–±—Ä–∞–±–æ—Ç—á–∏–∫) vs `entity` (–æ–±—ä–µ–∫—Ç –ë–î) ‚Äî —á—ë—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏.

4. **–Ø–≤–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**: –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö ‚Äî –¥–µ–ª–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —è–≤–Ω—ã–º–∏, —É–ø—Ä–æ—â–∞–µ—Ç –æ—Ç–ª–∞–¥–∫—É.

5. **Fallback-–º–µ—Ö–∞–Ω–∏–∑–º**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `eh` –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π.

### ‚ö†Ô∏è –ö—Ä–∏—Ç–∏–∫–∞ –∏ —Ä–∏—Å–∫–∏

#### 1. **–ö–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏**

**–†–∏—Å–∫: –ü—É—Ç–∞–Ω–∏—Ü–∞ —Å –∫–ª–∞—Å—Å–∞–º–∏ vs —ç–∫–∑–µ–º–ø–ª—è—Ä–∞–º–∏**

```python
# –ï—Å–ª–∏ –º—ã "–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä—ã eh":
class UserHandler:
    @classmethod
    def select(cls, entity_name: str, params: dict) -> Select:
        # –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ engine, metadata?
        # –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—å connection pool?
        pass
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ `eh` ‚Äî —ç—Ç–æ –∫–ª–∞—Å—Å –±–µ–∑ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤, —Ç–æ:
- –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (`engine`, `metadata`, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é)?
- –ö–∞–∫ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (connection pool, –∫—ç—à)?
- –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å mock-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏?

**–†–µ—à–µ–Ω–∏–µ 1**: Singleton-—ç–∫–∑–µ–º–ø–ª—è—Ä `eh` —Å –ª–µ–Ω–∏–≤–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
```python
class EntityHandler:
    _instance = None
    _engine = None
    _metadata = None
    
    @classmethod
    def initialize(cls, engine, metadata):
        cls._engine = engine
        cls._metadata = metadata
```

**–†–µ—à–µ–Ω–∏–µ 2**: –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤
```python
class Context:
    engine: Engine
    metadata: MetaData
    cache: Cache
    
def select(entity_name: str, params: dict, context: Context) -> Select:
    # –í—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –ø–µ—Ä–µ–¥–∞–Ω–æ —è–≤–Ω–æ
    pass
```

**–†–∏—Å–∫: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π**

> "–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —É–¥–æ–±–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–æ–ª—è—Ö –∫–ª–∞—Å—Å–∞, –ø–æ—Å–∫–æ–ª—å–∫—É SQLAlchemy –∏ –°–£–ë–î –æ –Ω–∏—Ö –Ω–∏—á–µ–≥–æ –Ω–µ –∑–Ω–∞–µ—Ç"

–ù–æ –µ—Å–ª–∏ –º—ã –Ω–µ —Å–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä—ã, —Ç–æ –≥–¥–µ —Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ?

```python
class VirtualViewHandler:
    # –ê—Ç—Ä–∏–±—É—Ç—ã –∫–ª–∞—Å—Å–∞? –ù–æ —Ç–æ–≥–¥–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è 
    # –Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å-–Ω–∞—Å–ª–µ–¥–Ω–∏–∫
    virtual_view_metadata = {
        "columns": [...],
        "description": "..."
    }
```

**–†–µ—à–µ–Ω–∏–µ**: –û—Ç–¥–µ–ª—å–Ω—ã–π registry –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
```python
virtual_views_metadata = {
    "user_summary": {
        "columns": [...],
        "handler": VirtualViewHandler
    }
}
```

#### 2. **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏**

**–†–∏—Å–∫: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ `eh` –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é**

> "–≤ –ø—Ä–æ–µ–∫—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É—é—â–µ–º UMA –º–æ–∂–µ—Ç –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å—Å—è –∫–ª–∞—Å—Å-–ø–æ—Ç–æ–º–æ–∫ –æ—Ç `eh` –ø–æ-–º–æ–ª—á–∞–Ω–∏—é"

–ö–∞–∫ –º–µ—Ö–∞–Ω–∏–∑–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —É–∑–Ω–∞–µ—Ç –æ –Ω–æ–≤–æ–º `eh` –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é?

```python
# –í–∞—Ä–∏–∞–Ω—Ç 1: –Ø–≤–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
uma.set_default_handler(MyCustomDefaultHandler)

# –í–∞—Ä–∏–∞–Ω—Ç 2: Convention - –∏—â–µ–º –∫–ª–∞—Å—Å —Å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º
class DefaultEntityHandler:  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    pass
```

**–†–∏—Å–∫: –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤**

> "–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ `eh` ‚Äì —ç—Ç–æ –º–æ–∂–Ω–æ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ"

–ù–æ –æ–ø–µ—Ä–∞—Ü–∏—è `meta` ‚Äî —á–∞—Å—Ç—å `eh`. –ö–∞–∫ `eh` –±—É–¥–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ Redis/–¥—Ä—É–≥–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞?

```python
class EntityHandler:
    @staticmethod
    def meta(entity_name: str, context: Context) -> dict:
        # –û—Ç–∫—É–¥–∞ –±—Ä–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ?
        # 1. –ò–∑ SQLAlchemy MetaData?
        # 2. –ò–∑ Redis?
        # 3. –ò–∑ –æ–±–æ–∏—Ö?
        pass
```

**–†–µ—à–µ–Ω–∏–µ**: –Ø–≤–Ω–∞—è –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –¥–ª—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
```python
class MetadataProvider(Protocol):
    def get_metadata(self, entity_name: str) -> dict:
        ...

class SQLAlchemyMetadataProvider:
    def get_metadata(self, entity_name: str) -> dict:
        # –ò–∑ metadata.tables[entity_name]
        pass

class RedisMetadataProvider:
    def get_metadata(self, entity_name: str) -> dict:
        # –ò–∑ Redis
        pass

class CompositeMetadataProvider:
    def get_metadata(self, entity_name: str) -> dict:
        # –°–Ω–∞—á–∞–ª–∞ SQLAlchemy, –∑–∞—Ç–µ–º –æ–±–æ–≥–∞—â–∞–µ–º –∏–∑ Redis
        pass
```

**–†–∏—Å–∫: CTE –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏**

> "—Ä–µ–∑—É–ª—å—Ç–∞—Ç `select` –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –≤—Å–µ–≥–¥–∞ –æ—Ñ–æ—Ä–º–ª—è–µ—Ç—Å—è –∫–∞–∫ CTE"

–≠—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –Ω–æ –Ω—É–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å:
- CTE –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ PostgreSQL 12+ (–º–æ–∂–µ—Ç –±—ã—Ç—å overhead)
- –ù—É–∂–Ω–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: –µ—Å–ª–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 3 —Ä–∞–∑–∞, CTE —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑

#### 3. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–∏—Å–∫–∏**

**–†–∏—Å–∫: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ –∏–º–µ–Ω–∏ —Å—É—â–Ω–æ—Å—Ç–∏**

> "–ö–ª—é—á–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —è–≤–ª—è–µ—Ç—Å—è –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏"

–ß—Ç–æ –µ—Å–ª–∏:
- –¢–∞–±–ª–∏—Ü–∞ `users` –∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ `users`?
- –î–≤–µ —Ä–∞–∑–Ω—ã–µ –ë–î —Å —Ç–∞–±–ª–∏—Ü–µ–π `users`?

```python
# –ö–æ–Ω—Ñ–ª–∏–∫—Ç –∏–º—ë–Ω
registry.register("users", CustomUserHandler)  # –¢–∞–±–ª–∏—Ü–∞ users
registry.register("users", VirtualUsersHandler)  # –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ users
```

**–†–µ—à–µ–Ω–∏–µ**: Namespace –∏–ª–∏ –ø—Ä–µ—Ñ–∏–∫—Å—ã
```python
registry.register("db:users", CustomUserHandler)
registry.register("virtual:users", VirtualUsersHandler)

# –ò–ª–∏ —è–≤–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
table_registry.register("users", CustomUserHandler)
virtual_registry.register("users", VirtualUsersHandler)
```

**–†–∏—Å–∫: –ö–∞–∫ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —á—Ç–æ —Å—É—â–Ω–æ—Å—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è?**

–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ JSQL –Ω—É–∂–Ω–æ –ø–æ–Ω—è—Ç—å:
- –≠—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –ë–î?
- –≠—Ç–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ?
- –≠—Ç–æ VIEW –≤ –ë–î?

```python
def resolve_entity(entity_name: str) -> tuple[EntityHandler, bool]:
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —è–≤–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    if entity_name in explicit_registry:
        handler, is_virtual = explicit_registry[entity_name]
        return handler, is_virtual
    
    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—ã –ë–î
    if entity_name in metadata.tables:
        return default_handler, False
    
    # 3. –ù–µ –Ω–∞–π–¥–µ–Ω–æ
    raise ValueError(f"Entity {entity_name} not found")
```

### üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

#### 1. **–Ø–≤–Ω—ã–π Context –æ–±—ä–µ–∫—Ç**

```python
@dataclass
class UMAContext:
    """–ö–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è UMA –æ–ø–µ—Ä–∞—Ü–∏–π"""
    engine: Engine
    metadata: MetaData
    metadata_provider: MetadataProvider
    user_context: Any  # –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞
    cache: Optional[Cache] = None
```

#### 2. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–µ–π**

```python
class EntityHandler(Protocol):
    """–ë–∞–∑–æ–≤—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è entity handlers"""
    
    @staticmethod
    def select(entity_name: str, params: dict, context: UMAContext) -> Select:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç SQLAlchemy Select"""
        ...
    
    @staticmethod
    def read(entity_name: str, id_value: Any, context: UMAContext) -> dict | None:
        """–ß–∏—Ç–∞–µ—Ç –∑–∞–ø–∏—Å—å –ø–æ id"""
        ...
    
    @staticmethod
    def save(entity_name: str, data: dict, context: UMAContext) -> Any:
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–ø–∏—Å—å"""
        ...
    
    @staticmethod
    def delete(entity_name: str, id_value: Any, context: UMAContext) -> bool:
        """–£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å"""
        ...

class MetadataHandler(Protocol):
    """–û—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö"""
    
    @staticmethod
    def meta(entity_name: str, context: UMAContext) -> dict:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏"""
        ...
```

## üèóÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –ë–∞–∑–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```python
from typing import Protocol, Any, runtime_checkable
from dataclasses import dataclass
from sqlalchemy import Engine, MetaData, Select

# ================== –ö–æ–Ω—Ç–µ–∫—Å—Ç ==================

@dataclass
class UMAContext:
    """–ö–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è UMA –æ–ø–µ—Ä–∞—Ü–∏–π"""
    engine: Engine
    metadata: MetaData
    user_context: Any = None
    cache: Any = None
    
    @property
    def connection(self):
        """–ü–æ–ª—É—á–∏—Ç—å connection –∏–∑ engine"""
        return self.engine.connect()

# ================== –ü—Ä–æ—Ç–æ–∫–æ–ª EntityHandler ==================

@runtime_checkable
class EntityHandler(Protocol):
    """
    –ü—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è entity handler.
    –í—Å–µ –º–µ—Ç–æ–¥—ã —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ - –Ω–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è.
    """
    
    @staticmethod
    def select(entity_name: str, params: dict[str, Any], context: UMAContext) -> Select:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç SQLAlchemy Select –¥–ª—è –≤—ã–±–æ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö.
        
        Args:
            entity_name: –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏ (—Ç–∞–±–ª–∏—Ü—ã)
            params: –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ JSQL
            context: –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        """
        ...
    
    @staticmethod
    def read(entity_name: str, id_value: Any, context: UMAContext) -> dict | None:
        """
        –ß–∏—Ç–∞–µ—Ç –æ–¥–Ω—É –∑–∞–ø–∏—Å—å –ø–æ id.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç select –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞.
        """
        ...
    
    @staticmethod
    def save(entity_name: str, data: dict, context: UMAContext) -> Any:
        """
        –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–ø–∏—Å—å (create –µ—Å–ª–∏ id=None, –∏–Ω–∞—á–µ update).
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç id —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏.
        """
        ...
    
    @staticmethod
    def delete(entity_name: str, id_value: Any, context: UMAContext) -> bool:
        """
        –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –ø–æ id.
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ read.
        """
        ...
    
    @staticmethod
    def meta(entity_name: str, context: UMAContext) -> dict:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏.
        """
        ...

# ================== –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é ==================

class DefaultEntityHandler:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –ë–î.
    –û–±—Å–ª—É–∂–∏–≤–∞–µ—Ç –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Ç–∞–±–ª–∏—Ü –±–µ–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏.
    """
    
    @staticmethod
    def select(entity_name: str, params: dict[str, Any], context: UMAContext) -> Select:
        """–ü—Ä–æ—Å—Ç–æ–π SELECT * FROM table"""
        from sqlalchemy import select
        
        table = context.metadata.tables[entity_name]
        return select(table)
    
    @staticmethod
    def read(entity_name: str, id_value: Any, context: UMAContext) -> dict | None:
        """–ß—Ç–µ–Ω–∏–µ —á–µ—Ä–µ–∑ select + —Ñ–∏–ª—å—Ç—Ä –ø–æ id"""
        from sqlalchemy import select
        
        # –ü–æ–ª—É—á–∞–µ–º select (—Å –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞, –µ—Å–ª–∏ –µ—Å—Ç—å)
        query = DefaultEntityHandler.select(entity_name, {}, context)
        
        # –î–æ–±–∞–≤–ª—è–µ–º —É—Å–ª–æ–≤–∏–µ –ø–æ id
        table = context.metadata.tables[entity_name]
        # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ PK - —ç—Ç–æ "id"
        # TODO: –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å PK –∏–∑ table.primary_key
        query = query.where(table.c.id == id_value)
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º
        with context.connection as conn:
            result = conn.execute(query).mappings().first()
            return dict(result) if result else None
    
    @staticmethod
    def save(entity_name: str, data: dict, context: UMAContext) -> Any:
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü—É"""
        from sqlalchemy import insert, update
        
        table = context.metadata.tables[entity_name]
        id_value = data.get("id")  # TODO: –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å PK –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
        is_create = (id_value is None)
        
        with context.engine.begin() as conn:
            if is_create:
                # INSERT
                stmt = insert(table).values(**data)
                result = conn.execute(stmt)
                return result.inserted_primary_key[0]
            else:
                # UPDATE
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
                existing = DefaultEntityHandler.read(entity_name, id_value, context)
                if existing is None:
                    raise PermissionError(f"No access to {entity_name}:{id_value}")
                
                stmt = update(table).where(table.c.id == id_value).values(**data)
                conn.execute(stmt)
                return id_value
    
    @staticmethod
    def delete(entity_name: str, id_value: Any, context: UMAContext) -> bool:
        """–£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã"""
        from sqlalchemy import delete as sql_delete
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
        existing = DefaultEntityHandler.read(entity_name, id_value, context)
        if existing is None:
            raise PermissionError(f"No access to delete {entity_name}:{id_value}")
        
        table = context.metadata.tables[entity_name]
        
        with context.engine.begin() as conn:
            stmt = sql_delete(table).where(table.c.id == id_value)
            result = conn.execute(stmt)
            return result.rowcount > 0
    
    @staticmethod
    def meta(entity_name: str, context: UMAContext) -> dict:
        """–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ SQLAlchemy MetaData"""
        table = context.metadata.tables[entity_name]
        
        columns = []
        for col in table.columns:
            col_info = {
                "name": col.name,
                "type": str(col.type),
                "nullable": col.nullable,
                "primary_key": col.primary_key,
            }
            
            # –í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏
            if col.foreign_keys:
                fk = list(col.foreign_keys)[0]
                col_info["related_to"] = fk.column.table.name
                col_info["related_key"] = fk.column.name
            
            columns.append(col_info)
        
        return {
            "name": entity_name,
            "description": "",  # –ú–æ–∂–Ω–æ –æ–±–æ–≥–∞—Ç–∏—Ç—å –∏–∑ COMMENT
            "columns": columns
        }

# ================== –ü—Ä–∏–º–µ—Ä –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ handler ==================

class RestrictedUserHandler:
    """
    Handler –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–∏ users —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –¥–æ—Å—Ç—É–ø–∞:
    –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
    """
    
    @staticmethod
    def select(entity_name: str, params: dict[str, Any], context: UMAContext) -> Select:
        """SELECT —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –¥–æ—Å—Ç—É–ø–∞"""
        from sqlalchemy import select
        
        table = context.metadata.tables[entity_name]
        query = select(table).where(table.c.active == True)
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ params
        if "department_id" in params:
            query = query.where(table.c.department_id == params["department_id"])
        
        return query
    
    @staticmethod
    def read(entity_name: str, id_value: Any, context: UMAContext) -> dict | None:
        """–ò—Å–ø–æ–ª—å–∑—É–µ–º DefaultEntityHandler.read, –Ω–æ —Å –Ω–∞—à–∏–º select"""
        # –ú–æ–∂–µ–º –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –∏–∑ default
        query = RestrictedUserHandler.select(entity_name, {}, context)
        
        table = context.metadata.tables[entity_name]
        query = query.where(table.c.id == id_value)
        
        with context.connection as conn:
            result = conn.execute(query).mappings().first()
            return dict(result) if result else None
    
    # save –∏ delete –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–∑ DefaultEntityHandler
    save = DefaultEntityHandler.save
    delete = DefaultEntityHandler.delete
    meta = DefaultEntityHandler.meta

# ================== –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è ==================

class VirtualViewHandler:
    """
    Handler –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π.
    –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –≤ registry.
    """
    
    @staticmethod
    def select(entity_name: str, params: dict[str, Any], context: UMAContext) -> Select:
        """
        –î–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π select –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
        –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é, –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
        –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π callable.
        """
        raise NotImplementedError("Virtual views must provide select function at registration")
    
    @staticmethod
    def read(entity_name: str, id_value: Any, context: UMAContext) -> dict | None:
        """–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –º–æ–≥—É—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å read"""
        raise NotImplementedError(f"Virtual view {entity_name} does not support read")
    
    @staticmethod
    def save(entity_name: str, data: dict, context: UMAContext) -> Any:
        """–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ–±—ã—á–Ω–æ readonly"""
        raise NotImplementedError(f"Virtual view {entity_name} is read-only")
    
    @staticmethod
    def delete(entity_name: str, id_value: Any, context: UMAContext) -> bool:
        """–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ–±—ã—á–Ω–æ readonly"""
        raise NotImplementedError(f"Virtual view {entity_name} is read-only")
    
    @staticmethod
    def meta(entity_name: str, context: UMAContext) -> dict:
        """–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ registry –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π"""
        # TODO: –ø–æ–ª—É—á–∏—Ç—å –∏–∑ virtual_views_registry
        pass
```

### 2. Entity Registry

```python
from typing import Callable, Type

class EntityRegistry:
    """
    –†–µ–µ—Å—Ç—Ä –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å—É—â–Ω–æ—Å—Ç–µ–π.
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç fallback –Ω–∞ handler –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é.
    """
    
    def __init__(self, default_handler: Type[EntityHandler] = DefaultEntityHandler):
        # –Ø–≤–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: entity_name -> handler class
        self._handlers: dict[str, Type[EntityHandler]] = {}
        
        # Handler –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é
        self._default_handler: Type[EntityHandler] = default_handler
        
        # –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è: entity_name -> select function
        self._virtual_views: dict[str, Callable] = {}
        
        # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
        self._virtual_metadata: dict[str, dict] = {}
    
    def register_handler(self, entity_name: str, handler: Type[EntityHandler]):
        """
        –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç handler –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–∏.
        –ï—Å–ª–∏ handler —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω, –∑–∞–º–µ–Ω—è–µ—Ç –µ–≥–æ.
        """
        if not isinstance(handler, type):
            raise TypeError("handler must be a class, not instance")
        
        self._handlers[entity_name] = handler
    
    def register_virtual_view(
        self,
        name: str,
        select_fn: Callable[[dict, UMAContext], Select],
        metadata: dict
    ):
        """
        –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ.
        
        Args:
            name: –∏–º—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
            select_fn: —Ñ—É–Ω–∫—Ü–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∞—è Select
            metadata: –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (columns, description, etc.)
        """
        self._virtual_views[name] = select_fn
        self._virtual_metadata[name] = metadata
    
    def get_handler(self, entity_name: str, context: UMAContext) -> Type[EntityHandler]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç handler –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–∏.
        
        –ü–æ—Ä—è–¥–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:
        1. –Ø–≤–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π handler
        2. –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
        3. –¢–∞–±–ª–∏—Ü–∞ –ë–î -> default handler
        4. ValueError
        """
        # 1. –Ø–≤–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        if entity_name in self._handlers:
            return self._handlers[entity_name]
        
        # 2. –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
        if entity_name in self._virtual_views:
            return VirtualViewHandler
        
        # 3. –¢–∞–±–ª–∏—Ü—ã –ë–î
        if entity_name in context.metadata.tables:
            return self._default_handler
        
        # 4. –ù–µ –Ω–∞–π–¥–µ–Ω–æ
        raise ValueError(f"Entity {entity_name} not found")
    
    def is_virtual(self, entity_name: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—É—â–Ω–æ—Å—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º"""
        return entity_name in self._virtual_views
    
    def get_virtual_select(
        self,
        entity_name: str,
        params: dict,
        context: UMAContext
    ) -> Select:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç Select –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è"""
        if entity_name not in self._virtual_views:
            raise ValueError(f"{entity_name} is not a virtual view")
        
        select_fn = self._virtual_views[entity_name]
        return select_fn(params, context)
    
    def list_all(self, context: UMAContext) -> list[str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π"""
        explicit = set(self._handlers.keys())
        virtual = set(self._virtual_views.keys())
        tables = set(context.metadata.tables.keys())
        
        return sorted(explicit | virtual | tables)
    
    def set_default_handler(self, handler: Type[EntityHandler]):
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç handler –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é"""
        self._default_handler = handler
```

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å JSQL

```python
def process_jsql(jsql: dict, params: dict, context: UMAContext, registry: EntityRegistry):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç JSQL –∑–∞–ø—Ä–æ—Å —Å —É—á—ë—Ç–æ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö handlers.
    """
    from_entity = jsql["from"]
    
    # –ü–æ–ª—É—á–∞–µ–º handler
    handler = registry.get_handler(from_entity, context)
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–µ–Ω –ª–∏ CTE
    if registry.is_virtual(from_entity):
        # –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ - –≤—Å–µ–≥–¥–∞ CTE
        entity_select = registry.get_virtual_select(from_entity, params, context)
        entity_cte = entity_select.cte(name=from_entity)
        base_selectable = entity_cte
    elif from_entity in registry._handlers:
        # –Ø–≤–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π handler - –∏—Å–ø–æ–ª—å–∑—É–µ–º CTE –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫
        entity_select = handler.select(from_entity, params, context)
        entity_cte = entity_select.cte(name=from_entity)
        base_selectable = entity_cte
    else:
        # –û–±—ã—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–ø—Ä—è–º—É—é
        base_selectable = context.metadata.tables[from_entity]
    
    # –°—Ç—Ä–æ–∏–º –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å
    query = build_query_from_jsql(jsql, base_selectable, registry, params, context)
    
    return query
```

### 4. API —Ñ—É–Ω–∫—Ü–∏–∏

```python
# –ì–ª–æ–±–∞–ª—å–Ω—ã–π registry (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
_registry: EntityRegistry = None
_context: UMAContext = None

def initialize_uma(engine: Engine, metadata: MetaData, default_handler = None):
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UMA"""
    global _registry, _context
    
    _context = UMAContext(engine=engine, metadata=metadata)
    _registry = EntityRegistry(default_handler or DefaultEntityHandler)
    
    return _registry

def uma_select(jsql: dict, params: dict = None, user_context: Any = None) -> dict:
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç JSQL –∑–∞–ø—Ä–æ—Å"""
    ctx = UMAContext(
        engine=_context.engine,
        metadata=_context.metadata,
        user_context=user_context
    )
    
    query = process_jsql(jsql, params or {}, ctx, _registry)
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    with ctx.connection as conn:
        result = conn.execute(query)
        return {
            "metadata": {},  # TODO
            "data": [dict(row) for row in result.mappings()]
        }

def uma_read(entity_name: str, id_value: Any, user_context: Any = None) -> dict | None:
    """–ß–∏—Ç–∞–µ—Ç –∑–∞–ø–∏—Å—å"""
    ctx = UMAContext(
        engine=_context.engine,
        metadata=_context.metadata,
        user_context=user_context
    )
    
    handler = _registry.get_handler(entity_name, ctx)
    return handler.read(entity_name, id_value, ctx)

def uma_save(entity_name: str, data: dict, user_context: Any = None) -> Any:
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–ø–∏—Å—å"""
    ctx = UMAContext(
        engine=_context.engine,
        metadata=_context.metadata,
        user_context=user_context
    )
    
    handler = _registry.get_handler(entity_name, ctx)
    return handler.save(entity_name, data, ctx)

def uma_delete(entity_name: str, id_value: Any, user_context: Any = None) -> bool:
    """–£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å"""
    ctx = UMAContext(
        engine=_context.engine,
        metadata=_context.metadata,
        user_context=user_context
    )
    
    handler = _registry.get_handler(entity_name, ctx)
    return handler.delete(entity_name, id_value, ctx)

def uma_meta(entity_name: str, user_context: Any = None) -> dict:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏"""
    ctx = UMAContext(
        engine=_context.engine,
        metadata=_context.metadata,
        user_context=user_context
    )
    
    handler = _registry.get_handler(entity_name, ctx)
    return handler.meta(entity_name, ctx)
```

### 5. –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```python
# ========== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ==========

engine = create_engine("postgresql://...")
metadata = MetaData()
metadata.reflect(bind=engine)

registry = initialize_uma(engine, metadata)

# ========== –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è handlers ==========

# 1. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º handler –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
registry.register_handler("users", RestrictedUserHandler)

# 2. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
def user_summary_select(params: dict, context: UMAContext) -> Select:
    from sqlalchemy import select, func
    
    users = context.metadata.tables["users"]
    orders = context.metadata.tables["orders"]
    
    return select(
        users.c.id,
        users.c.name,
        func.count(orders.c.id).label("order_count"),
        func.sum(orders.c.total).label("total_spent")
    ).select_from(
        users.outerjoin(orders)
    ).group_by(users.c.id, users.c.name).where(
        # –ü–æ–ª–∏—Ç–∏–∫–∞ –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ params
        users.c.id == params.get("user_id")
    )

registry.register_virtual_view(
    name="user_summary",
    select_fn=user_summary_select,
    metadata={
        "description": "–°–≤–æ–¥–∫–∞ –ø–æ –∑–∞–∫–∞–∑–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
        "columns": [
            {"name": "id", "type": "integer"},
            {"name": "name", "type": "string"},
            {"name": "order_count", "type": "integer"},
            {"name": "total_spent", "type": "numeric"}
        ]
    }
)

# 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π handler –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é
class MyDefaultHandler(DefaultEntityHandler):
    @staticmethod
    def select(entity_name: str, params: dict, context: UMAContext) -> Select:
        # –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        print(f"Selecting from {entity_name}")
        return DefaultEntityHandler.select(entity_name, params, context)

registry.set_default_handler(MyDefaultHandler)

# ========== –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ==========

# 1. –û–±—ã—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ (fallback –Ω–∞ default handler)
orders_data = uma_read("orders", 123)

# 2. –¢–∞–±–ª–∏—Ü–∞ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º handler (–ø–æ–ª–∏—Ç–∏–∫–∞ –¥–æ—Å—Ç—É–ø–∞)
user = uma_read("users", 456)  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è RestrictedUserHandler

# 3. –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
jsql = {
    "select": ["*"],
    "from": "user_summary",
    "params": {"user_id": 456}
}
summary = uma_select(jsql, user_context=current_user)

# 4. JSQL —Å JOIN –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏ —Ç–∞–±–ª–∏—Ü—ã
jsql = {
    "select": ["user_summary.name", "user_summary.total_spent", "departments.name"],
    "from": "user_summary",  # –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ (CTE)
    "joins": [{
        "type": "inner",
        "table": "departments",  # –û–±—ã—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
        "on": {"user_summary.id": "departments.manager_id"}
    }],
    "params": {"user_id": 456}
}
result = uma_select(jsql, user_context=current_user)
```

## üìù –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ:

1. **Stateless handlers** ‚Äî —É–ø—Ä–æ—â–∞–µ—Ç –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
2. **One-to-many mapping** ‚Äî –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
3. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ `eh` vs `entity`** ‚Äî —á—ë—Ç–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
4. **Fallback –º–µ—Ö–∞–Ω–∏–∑–º** ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π boilerplate

### ‚ö†Ô∏è –ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è:

1. **Context –æ–±—ä–µ–∫—Ç** ‚Äî —è–≤–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (engine, metadata, user_context)
2. **–û—Ç–¥–µ–ª—å–Ω—ã–π registry –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π** ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤–Ω–µ handlers
3. **CTE –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö handlers –∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π** ‚Äî –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫ –¥–æ—Å—Ç—É–ø–∞
4. **–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã** ‚Äî handlers –∫–∞–∫ namespace –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π, –∞ –Ω–µ –æ–±—ä–µ–∫—Ç—ã

### üöß –†–∏—Å–∫–∏ —Ç—Ä–µ–±—É—é—â–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è:

1. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ PK –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏** ‚Äî –Ω–µ –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `id`
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å CTE** ‚Äî –¥–ª—è PostgreSQL 12+ –º–æ–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
3. **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤** ‚Äî –Ω—É–∂–µ–Ω MetadataProvider
4. **Namespace –¥–ª—è –∏–º—ë–Ω** ‚Äî –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ table vs virtual view

–ö–æ–Ω—Ü–µ–ø—Ü–∏—è **–∂–∏–∑–Ω–µ—Å–ø–æ—Å–æ–±–Ω–∞ –∏ —ç–ª–µ–≥–∞–Ω—Ç–Ω–∞**! –ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ ‚Äî handlers –∫–∞–∫ stateless –∞–ª–≥–æ—Ä–∏—Ç–º—ã, –∞ –Ω–µ –æ–±—ä–µ–∫—Ç—ã —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º. –≠—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ.

–ì–æ—Ç–æ–≤ –æ–±—Å—É–¥–∏—Ç—å –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –Ω–∞—á–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –∫–æ–¥–∞.

---

**User**

(20260103-163225) (20260104-001939)
> 1. –ö–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏
> –†–∏—Å–∫: –ü—É—Ç–∞–Ω–∏—Ü–∞ —Å –∫–ª–∞—Å—Å–∞–º–∏ vs —ç–∫–∑–µ–º–ø–ª—è—Ä–∞–º–∏
> ... ... ...
> –†–µ—à–µ–Ω–∏–µ 2: –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤

–î–∞, –∏–º–µ–Ω–Ω–æ —Ç–∞–∫. –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤. –í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ —Å–∞–º–æ–π –ø–ª–æ—Ö–æ–π –∏–¥–µ–µ–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.

> –†–∏—Å–∫: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
>> "–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —É–¥–æ–±–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–æ–ª—è—Ö –∫–ª–∞—Å—Å–∞, –ø–æ—Å–∫–æ–ª—å–∫—É SQLAlchemy –∏ –°–£–ë–î –æ –Ω–∏—Ö –Ω–∏—á–µ–≥–æ –Ω–µ –∑–Ω–∞–µ—Ç"
> –ù–æ –µ—Å–ª–∏ –º—ã –Ω–µ —Å–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä—ã, —Ç–æ –≥–¥–µ —Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ?
> ```python
> class VirtualViewHandler:
>     # –ê—Ç—Ä–∏–±—É—Ç—ã –∫–ª–∞—Å—Å–∞? –ù–æ —Ç–æ–≥–¥–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
>     # –Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å-–Ω–∞—Å–ª–µ–¥–Ω–∏–∫
> ```

–î–∞, –∏–º–µ–Ω–Ω–æ —Ç–∞–∫. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —á–∞—â–µ –≤—Å–µ–≥–æ –±—É–¥–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π –Ω–∞—Å–ª–µ–¥–Ω–∏–∫.
–ù–æ —É –Ω–∞—Å –∑–¥–µ—Å—å –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —à–∏—Ä–æ–∫–∏–π –ø—Ä–æ—Å—Ç–æ—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∏—Å—Ç–æ—Ç—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã: –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –ø—Ä–æ–µ–∫—Ç–µ –º—ã –º–æ–∂–µ–º –¥–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è —Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–µ, –∏–ª–∏ –¥–∞–∂–µ —á–∏—Ç–∞—Ç—å –∏—Ö –∏–∑ –ë–î.
–ú—ã –º–æ–∂–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∞–º –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –ø—Ä–æ–µ–∫—Ç–Ω—ã—Ö –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å —Å–ø–æ—Å–æ–± —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö, –∏ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Å–ø–æ—Å–æ–± —Å —É—á—ë—Ç–æ–º `entity_name`, –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º–æ–≥–æ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö.

> 2. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏
> –†–∏—Å–∫: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ eh –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é
>> "–≤ –ø—Ä–æ–µ–∫—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É—é—â–µ–º UMA –º–æ–∂–µ—Ç –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å—Å—è –∫–ª–∞—Å—Å-–ø–æ—Ç–æ–º–æ–∫ –æ—Ç eh –ø–æ-–º–æ–ª—á–∞–Ω–∏—é"
> –ö–∞–∫ –º–µ—Ö–∞–Ω–∏–∑–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —É–∑–Ω–∞–µ—Ç –æ –Ω–æ–≤–æ–º eh –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é?
> ... ... ...
> ```
> # –í–∞—Ä–∏–∞–Ω—Ç 1: –Ø–≤–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
> uma.set_default_handler(MyCustomDefaultHandler)
> ```

–î–∞, –∏–º–µ–Ω–Ω–æ —Ç–∞–∫. –Ø–≤–Ω–æ–µ –ª—É—á—à–µ –Ω–µ—è–≤–Ω–æ–≥–æ.

> –†–∏—Å–∫: –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
>> "–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ eh ‚Äì —ç—Ç–æ –º–æ–∂–Ω–æ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ"
> –ù–æ –æ–ø–µ—Ä–∞—Ü–∏—è meta ‚Äî —á–∞—Å—Ç—å eh. –ö–∞–∫ eh –±—É–¥–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ Redis/–¥—Ä—É–≥–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞?
> ```
> class EntityHandler:
>     @staticmethod
>     def meta(entity_name: str, context: Context) -> dict:
> ```

–î—É–º–∞—é, –Ω–∞–º —Å–ª–µ–¥—É–µ—Ç –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–æ—Å–æ–± –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è `context`, –ø–æ–º–µ—Å—Ç–∏—Ç—å —Ç—É–¥–∞ —ç–∫–∑–µ–º–ø–ª—è—Ä `MetadataProvider`, —á—Ç–æ–±—ã –≤ `EntityHandler.meta` –º–æ–∂–Ω–æ –±—ã–ª–æ –∫ –Ω–µ–º—É –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è.

> –†–∏—Å–∫: CTE –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
>> "—Ä–µ–∑—É–ª—å—Ç–∞—Ç select –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –≤—Å–µ–≥–¥–∞ –æ—Ñ–æ—Ä–º–ª—è–µ—Ç—Å—è –∫–∞–∫ CTE"
> –≠—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –Ω–æ –Ω—É–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å:
> CTE –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ PostgreSQL 12+ (–º–æ–∂–µ—Ç –±—ã—Ç—å overhead)
> –ù—É–∂–Ω–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: –µ—Å–ª–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 3 —Ä–∞–∑–∞, CTE —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑

(.1) 
> CTE –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ PostgreSQL 12+ (–º–æ–∂–µ—Ç –±—ã—Ç—å overhead)

–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ "–º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ CTE" ‚Äì –Ω–∏–∫–æ–≥–¥–∞ –æ–± —ç—Ç–æ–º –Ω–µ —Å–ª—ã—à–∞–ª.
–ù—É, –∏ —É –Ω–∞—Å –Ω–µ —Ç–æ–ª—å–∫–æ PostgreSQL, –Ω–µ –¥—É–º–∞—é, —á—Ç–æ –∑–∞–≤—è–∑—ã–≤–∞—Ç—å—Å—è –Ω–∞ —ç—Ç—É –∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω—É—é –°–£–ë–î –Ω–∞ —É—Ä–æ–≤–Ω–µ UMA —Ö–æ—Ä–æ—à–∞—è –∏–¥–µ—è.

(.2) –Ø –¥—É–º–∞—é, –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é –º–æ–∂–Ω–æ –æ–±–µ—Å–ø–µ—á–∏—Ç—å —Ç–µ–º, —á—Ç–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ–≥–¥–∞ —Å–≤—è–∑–∞–Ω–æ —Å –∏–º–µ–Ω–µ–º —Å—É—â–Ω–æ—Å—Ç–∏.
–í –ø—Ä–æ—Ü–µ—Å—Å–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–±–æ—Ä–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π SQLAlchemy –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å —Å–ª–æ–≤–∞—Ä—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö CTE, –∫–ª—é—á–æ–º –≤ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ—Ç –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏.
–ü—Ä–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ `select` –æ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è, –∑–Ω–∞—è –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏  —ç—Ç–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è, –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ —Å–æ—Å–ª–∞—Ç—å—Å—è –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –≤ —Å–ª–æ–≤–∞—Ä–µ CTE, –µ—Å–ª–∏ –æ–Ω —É–∂–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω, –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å CTE –∏ –ø–æ–º–µ—Å—Ç–∏—Ç—å –µ–≥–æ –≤ —Å–ª–æ–≤–∞—Ä—å —Å –∫–ª—é—á–æ–º –ø–æ –∏–º–µ–Ω–∏ —Å—É—â–Ω–æ—Å—Ç–∏.

> 3. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–∏—Å–∫–∏
> –†–∏—Å–∫: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ –∏–º–µ–Ω–∏ —Å—É—â–Ω–æ—Å—Ç–∏
>> "–ö–ª—é—á–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —è–≤–ª—è–µ—Ç—Å—è –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏"
> –ß—Ç–æ –µ—Å–ª–∏:
> –¢–∞–±–ª–∏—Ü–∞ users –∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ users?
> –î–≤–µ —Ä–∞–∑–Ω—ã–µ –ë–î —Å —Ç–∞–±–ª–∏—Ü–µ–π users?
> ... ... ...
> –†–µ—à–µ–Ω–∏–µ: Namespace –∏–ª–∏ –ø—Ä–µ—Ñ–∏–∫—Å—ã

–î–∞, –≤—Å—ë –≤–µ—Ä–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–¥—Ö–æ–¥ —Å namesapaces. –ò–º—è —Å—É—â–Ω–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º.

> –†–∏—Å–∫: –ö–∞–∫ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —á—Ç–æ —Å—É—â–Ω–æ—Å—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è?
> –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ JSQL –Ω—É–∂–Ω–æ –ø–æ–Ω—è—Ç—å:
> –≠—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –ë–î?
> –≠—Ç–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ?
> –≠—Ç–æ VIEW –≤ –ë–î?

–ö–∞–∫ –Ω–∞—Å—á—ë—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∞—Ç—Ä–∏–±—É—Ç–∞ –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è?
–ù–∞–ø—Ä–∏–º–µ—Ä: `is_vitrual_view = True`?

> 1. –Ø–≤–Ω—ã–π Context –æ–±—ä–µ–∫—Ç

–î–∞, –æ—Ç–ª–∏—á–Ω–∞—è –º—ã—Å–ª—å. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è.

> 2. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–µ–π

–•–º... ü§î –í–æ—Ç —Ç—É—Ç —Ç—ã –º–µ–Ω—è –Ω–µ–º–Ω–æ–≥–æ –æ–∑–∞–¥–∞—á–∏–ª.
–¢—ã –ø–æ—á–µ–º—É-—Ç–æ –≤—ã–¥–µ–ª–∏–ª –¥–≤–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: –¥–ª—è select/CRUD –∏, –æ—Ç–¥–µ–ª—å–Ω–æ, –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö.
–ù—É, —è –±—ã –ø–æ–Ω—è–ª –±—ã, –µ—Å–ª–∏ –±—ã —Ç—ã –æ–ø—Ä–µ–¥–µ–ª–∏–ª —Ç—Ä–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è `select`, CRUD –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö...
–ù–æ –¥–∞–≤–∞–π —Å–Ω–∞—á–∞–ª–∞ –æ—Ç–≤–µ—Ç–∏–º –Ω–∞ –≤–æ–ø—Ä–æ—Å: –∞ —á—Ç–æ —ç—Ç–æ –Ω–∞–º –¥–∞—Å—Ç?
–°–º–æ—Ç—Ä–∏: –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ç–∏–ø–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞, –∫–æ–≥–¥–∞ –æ–Ω –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å EntityHandler —Ç–∞–∫–∏–µ:

(.1) –ù—É–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –≤—ã–±–æ—Ä–∫—É —Ç–∞–±–ª–∏—Ü—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–ª–Ω–æ–º–æ—á–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. ‚Äî –†–µ–∞–ª–∏–∑—É–µ–º `select`.

(.2) –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã. ‚Äî –†–µ–∞–ª–∏–∑—É–µ–º `save` –∏/–∏–ª–∏ `delete`.

(.3) –•–æ—Ç–∏–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ. ‚Äî –ß–∞—â–µ –≤—Å–µ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º—Å—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π `select` –∏ `meta`, –ø–æ—Å–∫–æ–ª—å–∫—É CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞–¥ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è–º–∏ —Ç—Ä—É–¥–Ω–æ —É–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –≤ –≥–æ–ª–æ–≤—É: –Ω—É –∫–∞–∫–∞—è —Ç–∞–º CRUD-–ª–æ–≥–∏–∫–∞, –µ—Å–ª–∏ `select` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç CROSS JOIN?

–ù–æ –≤ –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª—É—á–∞—è—Ö CRUD-–æ–ø–µ—Ä–∞—Ü–∏–∏ –º–æ–≥—É—Ç –æ–∫–∞–∑–∞—Ç—å—Å—è –≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω—ã.

(.4) –•–æ—Ç–∏–º —Å–æ–æ–±—â–∏—Ç—å —á—Ç–æ-—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ —Å—É—â–Ω–æ—Å—Ç–∏. ‚Äî –†–µ–∞–ª–∏–∑—É–µ–º `meta`, –≥–¥–µ –≤—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ –ø—Ä–µ–¥–∫–∞, –ø–æ—Å–ª–µ —á–µ–≥–æ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å —á—Ç–æ-—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ.

(.5) –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–≤–µ–¥–µ–Ω–∏–π –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö. –ù–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä–µ–≤–æ–¥—ã. ‚Äî –†–µ–∞–ª–∏–∑—É–µ–º —Å–≤–æ–π `MetadataProvider`, –∏–ª–∏ `EntityHandler` –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é.

(.6) (–í–´–ñ–ù–û!) –ù—É–∂–Ω–æ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π.
–Ø –æ–± —ç—Ç–æ–º –Ω–µ –≥–æ–≤–æ—Ä–∏–ª —Ä–∞–Ω–µ–µ, –Ω–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ ‚Äì –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –∏–º—ë–Ω –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ `<workspace>:<name>`, —á—Ç–æ–±—ã –∑–∞—Ç–µ–º —ç–ª–µ–º–µ–Ω—Ç —ç—Ç–æ–≥–æ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è –º–æ–∂–Ω–æ –±—ã–ª–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∫–∞—á–µ—Å—Ç–≤–µ `entity_name`.
–ü–æ—Å–∫–æ–ª—å–∫—É –∏—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å –º–Ω–æ–≥–æ (–∑–∞–ø—Ä–æ—Å—Ç–æ –º—ã –º–æ–∂–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å—Ö–µ–º–∞–º–∏, –∏–ª–∏ –¥–∞–∂–µ —Å —Ä–∞–∑–Ω—ã–º–∏ –ë–î!) –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –∑–∞–º–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è, –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ª—É—á—à–µ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—å —ç—Ç–∏ –≤—Ä–µ–º—è –∏ —Ä–µ—Å—É—Ä—Å—ã –¥–∞–ª–µ–µ.
–î—É–º–∞—é, `MetadataProvider` —Ö–æ—Ä–æ—à–µ–µ –º–µ—Å—Ç–æ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏.

> ‚ö†Ô∏è –ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è:
> ... ... ...
> –û—Ç–¥–µ–ª—å–Ω—ã–π registry –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤–Ω–µ handlers

–í —Å–≤–µ—Ç–µ –æ–±–æ–∑–Ω–∞—á–µ–Ω–Ω–æ–≥–æ –≤—ã—à–µ —è –Ω–µ –Ω–∞—Ö–æ–∂—É –æ—Å–Ω–æ–≤–∞–Ω–∏–π –≤–≤–æ–¥–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä –∏–º–µ–Ω–Ω–æ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π.
–î—É–º–∞—é, –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∞—Ç—Ä–∏–±—É—Ç –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–∏.

> CTE –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö handlers –∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π ‚Äî –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫ –¥–æ—Å—Ç—É–ø–∞

–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø–æ–ª–∏—Ç–∏–∫ –¥–æ—Å—Ç—É–ø–∞. –ü—Ä–µ–¥–ª–∞–≥–∞—é –¥–æ–±–∞–≤–∏—Ç—å –≤ `MetadataProvider` –º–µ—Ç–æ–¥ `can`, –≤ –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å:
* `entity_name` ‚Äì –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏
* `operation` ‚Äì —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏
* `context` ‚Äì —ç–∫–∑–µ–º–ø–ª—è—Ä `Context`

–ì–¥–µ —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ —ç—Ç–æ:
`list` ‚Äì –¥–æ—Å—Ç—É–ø –∫ —Å–ø–∏—Å–∫—É –∑–∞–ø–∏—Å–µ–π. –ï—Å–ª–∏ `can` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `True`, –∑–Ω–∞—á–∏—Ç, `select` EntityHandler –¥–æ—Å—Ç—É–ø–µ–Ω. –ò–Ω–∞—á–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ `UmaAccessDeniedError`.
`read` ‚Äì –¥–æ—Å—Ç—É–ø –∫ —á—Ç–µ–Ω–∏—é –∑–∞–ø–∏—Å–∏. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å `read`.
`write` ‚Äì –¥–æ—Å—Ç—É–ø –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å `save`.
`delete` ‚Äì –¥–æ—Å—Ç—É–ø –∫ —É–¥–∞–ª–µ–Ω–∏—é. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å `delete`.
`meta` ‚Äì –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å `meta` –≤ EntityHandler.

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ, –≤ `can` –º–æ–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π, –∫–æ–≥–¥–∞ –≤ –∫–∞—á–µ—Å—Ç–≤–µ `entity_name` –ø–µ—Ä–µ–¥–∞–Ω–∞ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞, –∞ –≤ –∫–∞—á–µ—Å—Ç–≤–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ `meta` ‚Äì —Ç–∞–∫ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–ø–∏—Å–∫–∞ —Å—É—â–Ω–æ—Å—Ç–µ–π.
–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏, –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –¥–∞–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–π –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ `can` –≤ –ø—Ä–æ–µ–∫—Ç–µ.

(.–ù–∞–±–ª—é–¥–µ–Ω–∏–µ) –í —Å–≤–µ—Ç–µ `MetadataProvider.can` –ª–µ–≥–∫–æ —Å–º–æ–¥–µ–ª–∏—Ä–æ–≤–∞—Ç—å `read_only` ‚Äì `read` –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–µ–Ω, –∞ `save` –∏ `delete` ‚Äì –Ω–µ—Ç.
‚Äî

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏ –æ—Ü–µ–Ω–∫—É, —Å–≤–æ–∏ –≤–æ–ø—Ä–æ—Å—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ —Å–≤–µ—Ç–µ –∏–∑–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –≤—ã—à–µ.


---

**Cursor**

–û—Ç–ª–∏—á–Ω–æ! –í–∏–∂—É, —á—Ç–æ –∫–æ–Ω—Ü–µ–ø—Ü–∏—è —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –±–æ–ª–µ–µ —á—ë—Ç–∫–æ–π. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞—é –¥–µ—Ç–∞–ª–∏ —Å —É—á—ë—Ç–æ–º –≤–∞—à–∏—Ö —É—Ç–æ—á–Ω–µ–Ω–∏–π.

## 1. –û –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ CTE –≤ PostgreSQL

### –ß—Ç–æ —Ç–∞–∫–æ–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è CTE?

–í PostgreSQL 12+ –ø–æ—è–≤–∏–ª–∞—Å—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–º, –∫–∞–∫ –°–£–ë–î –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç CTE:

**–ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π CTE** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤):
```sql
WITH user_orders AS MATERIALIZED (
    SELECT user_id, COUNT(*) as order_count
    FROM orders
    GROUP BY user_id
)
SELECT * FROM user_orders WHERE order_count > 10;
```
- CTE –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–æ–¥–∏–Ω —Ä–∞–∑**
- –†–µ–∑—É–ª—å—Ç–∞—Ç **—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É**
- –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ CTE –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- **–ü–ª—é—Å—ã**: –≥–∞—Ä–∞–Ω—Ç–∏—è –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –¥–æ—Ä–æ–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **–ú–∏–Ω—É—Å—ã**: –º–æ–∂–µ—Ç –ø–æ–º–µ—à–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä—É (–Ω–µ –º–æ–∂–µ—Ç "–ø—Ä–æ—Ç–æ–ª–∫–Ω—É—Ç—å" —Ñ–∏–ª—å—Ç—Ä—ã –≤–Ω—É—Ç—Ä—å CTE)

**–ù–µ–ºaterial–∏–∑–æ–≤–∞–Ω–Ω—ã–π CTE** (–º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —è–≤–Ω–æ):
```sql
WITH user_orders AS NOT MATERIALIZED (
    SELECT user_id, COUNT(*) as order_count
    FROM orders
    GROUP BY user_id
)
SELECT * FROM user_orders WHERE order_count > 10;
```
- CTE **–≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è** –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å (inline)
- –û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- **–ü–ª—é—Å—ã**: –ª—É—á—à–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- **–ú–∏–Ω—É—Å—ã**: –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑, –µ—Å–ª–∏ CTE –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ

### –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è UMA?

–ï—Å–ª–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ—Ñ–æ—Ä–º–ª—è–µ—Ç—Å—è –∫–∞–∫ CTE, —Ç–æ:
- PostgreSQL 12+ **–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç** –µ–≥–æ
- –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å **overhead**, –µ—Å–ª–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ –µ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤–Ω—É—Ç—Ä–∏ CTE

**–†–µ—à–µ–Ω–∏–µ**: 
1. –î–ª—è –º–µ–∂–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ—Å—Ç–∏ **–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º** MATERIALIZED/NOT MATERIALIZED (—ç—Ç–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ PostgreSQL)
2. SQLAlchemy Core –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ–∑–¥–∞—ë—Ç CTE –±–µ–∑ —è–≤–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
3. –î–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π CTE - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä, —Ç.–∫. –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç:
   - –û–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (–≤–∞–∂–Ω–æ –¥–ª—è –¥–æ—Ä–æ–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)
   - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫ –¥–æ—Å—Ç—É–ø–∞
   - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏

**–í—ã–≤–æ–¥**: –ù–µ –Ω—É–∂–Ω–æ –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å—Å—è –∫ PostgreSQL. CTE –≤ SQLAlchemy —Ä–∞–±–æ—Ç–∞–µ—Ç –∫—Ä–æ—Å—Å-–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ, –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è - —ç—Ç–æ –¥–µ—Ç–∞–ª—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –°–£–ë–î.

## 2. –£—Ç–æ—á–Ω—ë–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –£–±–∏—Ä–∞–µ–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ EntityHandler/MetadataHandler

–í—ã –ø—Ä–∞–≤—ã - –Ω–µ—Ç —Å–º—ã—Å–ª–∞ —Ä–∞–∑–¥–µ–ª—è—Ç—å. –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∞–Ω—ã —Å —Å—É—â–Ω–æ—Å—Ç—å—é. –û—Å—Ç–∞—ë–º—Å—è —Å **–µ–¥–∏–Ω—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º EntityHandler**.

### –ü–µ—Ä–µ—Å–º–æ—Ç—Ä —Å —É—á—ë—Ç–æ–º –≤–∞—à–∏—Ö —É—Ç–æ—á–Ω–µ–Ω–∏–π

```python
from typing import Protocol, Any, runtime_checkable, Literal
from dataclasses import dataclass, field
from sqlalchemy import Engine, MetaData, Select

# ================== –¢–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π ==================

Operation = Literal["list", "read", "write", "delete", "meta"]

# ================== MetadataProvider ==================

@runtime_checkable
class MetadataProvider(Protocol):
    """
    –ü—Ä–æ–≤–∞–π–¥–µ—Ä –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏ –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞.
    """
    
    def get_metadata(self, entity_name: str, context: 'UMAContext') -> dict:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏.
        –ú–æ–∂–µ—Ç –æ–±–æ–≥–∞—â–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (–ë–î, Redis, –∫–æ–Ω—Ñ–∏–≥).
        """
        ...
    
    def list_entities(self, context: 'UMAContext') -> list[str]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ <workspace>:<name>.
        –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º.
        """
        ...
    
    def can(
        self,
        entity_name: str,
        operation: Operation,
        context: 'UMAContext'
    ) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞–¥ —Å—É—â–Ω–æ—Å—Ç—å—é.
        
        Args:
            entity_name: –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏ (–∏–ª–∏ "" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–ø–∏—Å–∫—É)
            operation: —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ (list/read/write/delete/meta)
            context: –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            
        Returns:
            True –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω
            
        Raises:
            UmaAccessDeniedError –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω
            
        –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏:
        - entity_name="" + operation="meta" -> –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–ø–∏—Å–∫—É —Å—É—â–Ω–æ—Å—Ç–µ–π
        """
        ...

# ================== Context ==================

@dataclass
class UMAContext:
    """
    –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è UMA –æ–ø–µ—Ä–∞—Ü–∏–π.
    –ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –º–µ—Ç–æ–¥–æ–≤ EntityHandler.
    """
    engine: Engine
    metadata: MetaData
    metadata_provider: MetadataProvider
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤)
    user_context: Any = None
    
    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫—ç—à
    cache: Any = None
    
    # –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è CTE (–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è)
    _cte_cache: dict[str, Any] = field(default_factory=dict)
    
    @property
    def connection(self):
        """–ü–æ–ª—É—á–∏—Ç—å connection –∏–∑ engine"""
        return self.engine.connect()
    
    def get_or_create_cte(self, entity_name: str, select_fn) -> Any:
        """
        –ü–æ–ª—É—á–∞–µ—Ç CTE –∏–∑ –∫—ç—à–∞ –∏–ª–∏ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π.
        –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é CTE –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π.
        
        Args:
            entity_name: –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏
            select_fn: —Ñ—É–Ω–∫—Ü–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∞—è Select (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ CTE –Ω–µ—Ç –≤ –∫—ç—à–µ)
        """
        if entity_name not in self._cte_cache:
            select_query = select_fn()
            self._cte_cache[entity_name] = select_query.cte(name=entity_name)
        return self._cte_cache[entity_name]

# ================== –ò—Å–∫–ª—é—á–µ–Ω–∏—è ==================

class UmaAccessDeniedError(PermissionError):
    """–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫–∞–∑–µ –≤ –¥–æ—Å—Ç—É–ø–µ"""
    def __init__(self, entity_name: str, operation: Operation, message: str = None):
        self.entity_name = entity_name
        self.operation = operation
        super().__init__(message or f"Access denied to {operation} on {entity_name}")

# ================== EntityHandler Protocol ==================

@runtime_checkable
class EntityHandler(Protocol):
    """
    –ü—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å—É—â–Ω–æ—Å—Ç–µ–π.
    –í—Å–µ –º–µ—Ç–æ–¥—ã —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ - –Ω–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è.
    –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π —Ö—Ä–∞–Ω—è—Ç—Å—è –∫–∞–∫ –∞—Ç—Ä–∏–±—É—Ç—ã –∫–ª–∞—Å—Å–∞.
    """
    
    # –ê—Ç—Ä–∏–±—É—Ç—ã –∫–ª–∞—Å—Å–∞ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
    is_virtual_view: bool = False
    description: str = ""
    # –î—Ä—É–≥–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    
    @staticmethod
    def select(entity_name: str, params: dict[str, Any], context: UMAContext) -> Select:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç SQLAlchemy Select –¥–ª—è –≤—ã–±–æ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö.
        –ò–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞ (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å—Ç—Ä–æ–∫).
        
        Args:
            entity_name: –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏
            params: –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ JSQL
            context: –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            
        Note:
            –ü–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ context.metadata_provider.can()
        """
        ...
    
    @staticmethod
    def read(entity_name: str, id_value: Any, context: UMAContext) -> dict | None:
        """
        –ß–∏—Ç–∞–µ—Ç –æ–¥–Ω—É –∑–∞–ø–∏—Å—å –ø–æ id.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç select() –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫ –¥–æ—Å—Ç—É–ø–∞.
        
        Note:
            –ü–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ context.metadata_provider.can()
        """
        ...
    
    @staticmethod
    def save(entity_name: str, data: dict, context: UMAContext) -> Any:
        """
        –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–ø–∏—Å—å (create –µ—Å–ª–∏ id=None, –∏–Ω–∞—á–µ update).
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç id —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏.
        
        Note:
            –ü–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ context.metadata_provider.can()
        """
        ...
    
    @staticmethod
    def delete(entity_name: str, id_value: Any, context: UMAContext) -> bool:
        """
        –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –ø–æ id.
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ read() –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º.
        
        Note:
            –ü–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ context.metadata_provider.can()
        """
        ...
    
    @staticmethod
    def meta(entity_name: str, context: UMAContext) -> dict:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏.
        –ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å context.metadata_provider –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö.
        
        Note:
            –ü–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ context.metadata_provider.can()
        """
        ...
```

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è DefaultEntityHandler

```python
class DefaultEntityHandler:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –ë–î.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ fallback –¥–ª—è –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π.
    """
    
    is_virtual_view = False
    
    @staticmethod
    def select(entity_name: str, params: dict[str, Any], context: UMAContext) -> Select:
        """–ü—Ä–æ—Å—Ç–æ–π SELECT * FROM table"""
        from sqlalchemy import select
        
        table = context.metadata.tables[entity_name]
        query = select(table)
        
        # params –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        # –ù–æ –æ–±—ã—á–Ω–æ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –≤ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã—Ö –∫–ª–∞—Å—Å–∞—Ö
        
        return query
    
    @staticmethod
    def read(entity_name: str, id_value: Any, context: UMAContext) -> dict | None:
        """–ß—Ç–µ–Ω–∏–µ —á–µ—Ä–µ–∑ select + —Ñ–∏–ª—å—Ç—Ä –ø–æ id"""
        # –ü–æ–ª—É—á–∞–µ–º select (—Å –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞, –µ—Å–ª–∏ –æ–Ω–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–æ–º –∫–ª–∞—Å—Å–µ)
        query = DefaultEntityHandler.select(entity_name, {}, context)
        
        # –î–æ–±–∞–≤–ª—è–µ–º —É—Å–ª–æ–≤–∏–µ –ø–æ id
        table = context.metadata.tables[entity_name]
        pk_columns = list(table.primary_key.columns)
        
        if len(pk_columns) == 1:
            # –ü—Ä–æ—Å—Ç–æ–π PK
            query = query.where(pk_columns[0] == id_value)
        else:
            # –°–æ—Å—Ç–∞–≤–Ω–æ–π PK
            from sqlalchemy import and_
            conditions = [col == val for col, val in zip(pk_columns, id_value)]
            query = query.where(and_(*conditions))
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º
        with context.connection as conn:
            result = conn.execute(query).mappings().first()
            return dict(result) if result else None
    
    @staticmethod
    def save(entity_name: str, data: dict, context: UMAContext) -> Any:
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü—É"""
        from sqlalchemy import insert, update
        
        table = context.metadata.tables[entity_name]
        pk_columns = list(table.primary_key.columns)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º create vs update
        if len(pk_columns) == 1:
            id_value = data.get(pk_columns[0].name)
        else:
            id_value = tuple(data.get(col.name) for col in pk_columns)
        
        is_create = (id_value is None or (isinstance(id_value, tuple) and None in id_value))
        
        with context.engine.begin() as conn:
            if is_create:
                # INSERT
                stmt = insert(table).values(**data)
                result = conn.execute(stmt)
                
                if len(pk_columns) == 1:
                    return result.inserted_primary_key[0]
                else:
                    return result.inserted_primary_key
            else:
                # UPDATE
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
                existing = DefaultEntityHandler.read(entity_name, id_value, context)
                if existing is None:
                    raise UmaAccessDeniedError(
                        entity_name,
                        "write",
                        f"No access to update {entity_name}:{id_value}"
                    )
                
                # –°—Ç—Ä–æ–∏–º —É—Å–ª–æ–≤–∏–µ –ø–æ PK
                if len(pk_columns) == 1:
                    pk_condition = pk_columns[0] == id_value
                else:
                    from sqlalchemy import and_
                    pk_condition = and_(*[col == val for col, val in zip(pk_columns, id_value)])
                
                stmt = update(table).where(pk_condition).values(**data)
                conn.execute(stmt)
                return id_value
    
    @staticmethod
    def delete(entity_name: str, id_value: Any, context: UMAContext) -> bool:
        """–£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã"""
        from sqlalchemy import delete as sql_delete
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
        existing = DefaultEntityHandler.read(entity_name, id_value, context)
        if existing is None:
            raise UmaAccessDeniedError(
                entity_name,
                "delete",
                f"No access to delete {entity_name}:{id_value}"
            )
        
        table = context.metadata.tables[entity_name]
        pk_columns = list(table.primary_key.columns)
        
        # –°—Ç—Ä–æ–∏–º —É—Å–ª–æ–≤–∏–µ –ø–æ PK
        if len(pk_columns) == 1:
            pk_condition = pk_columns[0] == id_value
        else:
            from sqlalchemy import and_
            pk_condition = and_(*[col == val for col, val in zip(pk_columns, id_value)])
        
        with context.engine.begin() as conn:
            stmt = sql_delete(table).where(pk_condition)
            result = conn.execute(stmt)
            return result.rowcount > 0
    
    @staticmethod
    def meta(entity_name: str, context: UMAContext) -> dict:
        """–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ SQLAlchemy MetaData + –æ–±–æ–≥–∞—â–µ–Ω–∏–µ –∏–∑ MetadataProvider"""
        table = context.metadata.tables[entity_name]
        
        columns = []
        for col in table.columns:
            col_info = {
                "name": col.name,
                "type": str(col.type),
                "nullable": col.nullable,
                "primary_key": col.primary_key,
            }
            
            # –í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏
            if col.foreign_keys:
                fk = list(col.foreign_keys)[0]
                col_info["related_to"] = fk.column.table.name
                col_info["related_key"] = fk.column.name
            
            columns.append(col_info)
        
        metadata = {
            "name": entity_name,
            "description": "",
            "is_virtual_view": False,
            "columns": columns
        }
        
        # –û–±–æ–≥–∞—â–∞–µ–º –∏–∑ MetadataProvider
        try:
            provider_metadata = context.metadata_provider.get_metadata(entity_name, context)
            metadata.update(provider_metadata)
        except Exception:
            pass  # –ï—Å–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ - –Ω–µ —Å—Ç—Ä–∞—à–Ω–æ
        
        return metadata
```

### –ü—Ä–∏–º–µ—Ä –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è

```python
class UserSummaryView:
    """
    –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ: —Å–≤–æ–¥–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.
    –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –∫–∞–∫ –∞—Ç—Ä–∏–±—É—Ç—ã –∫–ª–∞—Å—Å–∞.
    """
    
    # –ê—Ç—Ä–∏–±—É—Ç—ã –∫–ª–∞—Å—Å–∞ - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    is_virtual_view = True
    description = "–°–≤–æ–¥–∫–∞ –ø–æ –∑–∞–∫–∞–∑–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
    
    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    columns_metadata = [
        {"name": "user_id", "type": "integer", "description": "ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"},
        {"name": "name", "type": "string", "description": "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"},
        {"name": "order_count", "type": "integer", "description": "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤"},
        {"name": "total_spent", "type": "numeric", "description": "–û–±—â–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–æ–≤"}
    ]
    
    @staticmethod
    def select(entity_name: str, params: dict[str, Any], context: UMAContext) -> Select:
        """–§–æ—Ä–º–∏—Ä—É–µ—Ç –≤—ã–±–æ—Ä–∫—É —Å –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π"""
        from sqlalchemy import select, func
        
        users = context.metadata.tables["users"]
        orders = context.metadata.tables["orders"]
        
        query = select(
            users.c.id.label("user_id"),
            users.c.name,
            func.count(orders.c.id).label("order_count"),
            func.coalesce(func.sum(orders.c.total), 0).label("total_spent")
        ).select_from(
            users.outerjoin(orders, users.c.id == orders.c.user_id)
        ).group_by(users.c.id, users.c.name)
        
        # –ü–æ–ª–∏—Ç–∏–∫–∞ –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ params
        if "user_id" in params:
            query = query.where(users.c.id == params["user_id"])
        
        # –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å user_context –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
        if context.user_context:
            # –ù–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–≥–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞
            user_dept = getattr(context.user_context, "department_id", None)
            if user_dept:
                query = query.where(users.c.department_id == user_dept)
        
        return query
    
    @staticmethod
    def read(entity_name: str, id_value: Any, context: UMAContext) -> dict | None:
        """–î–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π read –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è"""
        # –ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ select + —Ñ–∏–ª—å—Ç—Ä
        query = UserSummaryView.select(entity_name, {"user_id": id_value}, context)
        
        with context.connection as conn:
            result = conn.execute(query).mappings().first()
            return dict(result) if result else None
    
    @staticmethod
    def save(entity_name: str, data: dict, context: UMAContext) -> Any:
        """–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ - read-only"""
        raise UmaAccessDeniedError(entity_name, "write", "Virtual view is read-only")
    
    @staticmethod
    def delete(entity_name: str, id_value: Any, context: UMAContext) -> bool:
        """–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ - read-only"""
        raise UmaAccessDeniedError(entity_name, "delete", "Virtual view is read-only")
    
    @staticmethod
    def meta(entity_name: str, context: UMAContext) -> dict:
        """–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –∫–ª–∞—Å—Å–∞"""
        return {
            "name": entity_name,
            "description": UserSummaryView.description,
            "is_virtual_view": True,
            "columns": UserSummaryView.columns_metadata
        }
```

### EntityRegistry

```python
class EntityRegistry:
    """
    –†–µ–µ—Å—Ç—Ä –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å—É—â–Ω–æ—Å—Ç–µ–π.
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç namespace –¥–ª—è –∏–º—ë–Ω —Å—É—â–Ω–æ—Å—Ç–µ–π.
    """
    
    def __init__(self, default_handler: type[EntityHandler] = DefaultEntityHandler):
        # –Ø–≤–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: <namespace>:<entity_name> -> handler class
        self._handlers: dict[str, type[EntityHandler]] = {}
        
        # Handler –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é
        self._default_handler: type[EntityHandler] = default_handler
    
    def register(
        self,
        entity_name: str,
        handler: type[EntityHandler],
        namespace: str = "default"
    ):
        """
        –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç handler –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–∏.
        
        Args:
            entity_name: –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏ (–±–µ–∑ namespace)
            handler: –∫–ª–∞—Å—Å handler
            namespace: –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∏–º—ë–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "default")
        """
        if not isinstance(handler, type):
            raise TypeError("handler must be a class, not instance")
        
        full_name = f"{namespace}:{entity_name}"
        self._handlers[full_name] = handler
    
    def get_handler(
        self,
        entity_name: str,
        context: UMAContext,
        namespace: str = "default"
    ) -> type[EntityHandler]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç handler –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–∏.
        
        –ü–æ—Ä—è–¥–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:
        1. –Ø–≤–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π handler (—Å namespace)
        2. –¢–∞–±–ª–∏—Ü–∞ –ë–î (–±–µ–∑ namespace) -> default handler
        3. ValueError
        
        Args:
            entity_name: –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏ (–º–æ–∂–µ—Ç –±—ã—Ç—å —Å namespace: "ns:name" –∏–ª–∏ –±–µ–∑)
            context: –∫–æ–Ω—Ç–µ–∫—Å—Ç
            namespace: namespace –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –µ—Å–ª–∏ entity_name –±–µ–∑ namespace)
        """
        # –†–∞–∑–±–∏—Ä–∞–µ–º entity_name
        if ":" in entity_name:
            # –Ø–≤–Ω–æ —É–∫–∞–∑–∞–Ω namespace
            full_name = entity_name
            _, pure_name = entity_name.split(":", 1)
        else:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º namespace –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            full_name = f"{namespace}:{entity_name}"
            pure_name = entity_name
        
        # 1. –Ø–≤–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        if full_name in self._handlers:
            return self._handlers[full_name]
        
        # 2. –¢–∞–±–ª–∏—Ü—ã –ë–î (—Ç–æ–ª—å–∫–æ –¥–ª—è default namespace)
        if namespace == "default" and pure_name in context.metadata.tables:
            return self._default_handler
        
        # 3. –ù–µ –Ω–∞–π–¥–µ–Ω–æ
        raise ValueError(f"Entity {full_name} not found")
    
    def is_registered(self, entity_name: str, namespace: str = "default") -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—É—â–Ω–æ—Å—Ç—å —è–≤–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π"""
        if ":" in entity_name:
            full_name = entity_name
        else:
            full_name = f"{namespace}:{entity_name}"
        
        return full_name in self._handlers
    
    def is_virtual_view(
        self,
        entity_name: str,
        context: UMAContext,
        namespace: str = "default"
    ) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—É—â–Ω–æ—Å—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º"""
        try:
            handler = self.get_handler(entity_name, context, namespace)
            return getattr(handler, "is_virtual_view", False)
        except ValueError:
            return False
    
    def set_default_handler(self, handler: type[EntityHandler]):
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç handler –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é"""
        self._default_handler = handler
    
    def list_registered(self) -> list[str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π (—Å namespace)"""
        return list(self._handlers.keys())
```

### MetadataProvider - –±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

```python
class DefaultMetadataProvider:
    """
    –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö.
    –ú–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∞ –≤ –ø—Ä–æ–µ–∫—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –ª–æ–≥–∏–∫–∏.
    """
    
    def __init__(self, registry: EntityRegistry):
        self.registry = registry
        self._entities_cache: dict[str, list[str]] = {}  # workspace -> list of entities
        self._cache_timestamp: dict[str, float] = {}
        self._cache_ttl: float = 300.0  # 5 –º–∏–Ω—É—Ç
    
    def get_metadata(self, entity_name: str, context: UMAContext) -> dict:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏.
        –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å.
        –í –ø—Ä–æ–µ–∫—Ç–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Redis/–∫–æ–Ω—Ñ–∏–≥–∞.
        """
        # –ü—Ä–∏–º–µ—Ä: –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –∏ —Ç.–¥.
        return {}
    
    def list_entities(self, context: UMAContext, namespace: str = "default") -> list[str]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ <namespace>:<name>.
        –ö—ç—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
        """
        import time
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        if namespace in self._entities_cache:
            cache_age = time.time() - self._cache_timestamp.get(namespace, 0)
            if cache_age < self._cache_ttl:
                return self._entities_cache[namespace]
        
        # –°–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫
        entities = set()
        
        # 1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ handlers
        for full_name in self.registry.list_registered():
            if full_name.startswith(f"{namespace}:"):
                entities.add(full_name)
        
        # 2. –¢–∞–±–ª–∏—Ü—ã –ë–î (—Ç–æ–ª—å–∫–æ –¥–ª—è default namespace)
        if namespace == "default":
            for table_name in context.metadata.tables.keys():
                entities.add(f"{namespace}:{table_name}")
        
        result = sorted(entities)
        
        # –ö—ç—à–∏—Ä—É–µ–º
        self._entities_cache[namespace] = result
        self._cache_timestamp[namespace] = time.time()
        
        return result
    
    def can(
        self,
        entity_name: str,
        operation: Operation,
        context: UMAContext
    ) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –æ–ø–µ—Ä–∞—Ü–∏–∏.
        –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –≤—Å—ë.
        –í –ø—Ä–æ–µ–∫—Ç–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤.
        
        Raises:
            UmaAccessDeniedError –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω
        """
        # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–ª—É—á–∞–π: –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–ø–∏—Å–∫—É —Å—É—â–Ω–æ—Å—Ç–µ–π
        if entity_name == "" and operation == "meta":
            # –†–∞–∑—Ä–µ—à–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Å–µ–º
            return True
        
        # –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: –≤—Å—ë —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
        # –í –ø—Ä–æ–µ–∫—Ç–µ –∑–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ:
        # - context.user_context (—Ä–æ–ª—å, –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
        # - entity_name (–∫–∞–∫–∞—è —Å—É—â–Ω–æ—Å—Ç—å)
        # - operation (–∫–∞–∫–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è)
        
        return True
```

### API —Ñ—É–Ω–∫—Ü–∏–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ—Å—Ç—É–ø–∞

```python
# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ)
_registry: EntityRegistry = None
_context_template: UMAContext = None

def initialize_uma(
    engine: Engine,
    metadata: MetaData,
    metadata_provider: MetadataProvider = None,
    default_handler: type[EntityHandler] = None
) -> EntityRegistry:
    """
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UMA.
    
    Args:
        engine: SQLAlchemy Engine
        metadata: SQLAlchemy MetaData (–æ—Ç—Ä–µ—Ñ–ª–µ–∫—á–µ–Ω–Ω—ã–π)
        metadata_provider: –ø—Ä–æ–≤–∞–π–¥–µ—Ä –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ None - —Å–æ–∑–¥–∞—ë—Ç—Å—è DefaultMetadataProvider)
        default_handler: handler –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é (–µ—Å–ª–∏ None - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è DefaultEntityHandler)
    """
    global _registry, _context_template
    
    _registry = EntityRegistry(default_handler or DefaultEntityHandler)
    
    if metadata_provider is None:
        metadata_provider = DefaultMetadataProvider(_registry)
    
    _context_template = UMAContext(
        engine=engine,
        metadata=metadata,
        metadata_provider=metadata_provider
    )
    
    return _registry

def _create_context(user_context: Any = None) -> UMAContext:
    """–°–æ–∑–¥–∞—ë—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏"""
    return UMAContext(
        engine=_context_template.engine,
        metadata=_context_template.metadata,
        metadata_provider=_context_template.metadata_provider,
        user_context=user_context
    )

def _check_access(entity_name: str, operation: Operation, context: UMAContext):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø –∏ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω"""
    if not context.metadata_provider.can(entity_name, operation, context):
        raise UmaAccessDeniedError(entity_name, operation)

# ========== API —Ñ—É–Ω–∫—Ü–∏–∏ ==========

def uma_select(
    jsql: dict,
    params: dict = None,
    user_context: Any = None,
    namespace: str = "default"
) -> dict:
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç JSQL –∑–∞–ø—Ä–æ—Å"""
    context = _create_context(user_context)
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º entity_name –∏–∑ JSQL
    entity_name = jsql.get("from")
    if not entity_name:
        raise ValueError("JSQL must contain 'from' field")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –æ–ø–µ—Ä–∞—Ü–∏–∏ list
    _check_access(entity_name, "list", context)
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º JSQL
    query = process_jsql(jsql, params or {}, context, _registry, namespace)
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º
    with context.connection as conn:
        result = conn.execute(query)
        return {
            "metadata": {},  # TODO: –∑–∞–ø–æ–ª–Ω–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            "data": [dict(row) for row in result.mappings()]
        }

def uma_read(
    entity_name: str,
    id_value: Any,
    user_context: Any = None,
    namespace: str = "default"
) -> dict | None:
    """–ß–∏—Ç–∞–µ—Ç –∑–∞–ø–∏—Å—å"""
    context = _create_context(user_context)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
    _check_access(entity_name, "read", context)
    
    handler = _registry.get_handler(entity_name, context, namespace)
    return handler.read(entity_name, id_value, context)

def uma_save(
    entity_name: str,
    data: dict,
    user_context: Any = None,
    namespace: str = "default"
) -> Any:
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–ø–∏—Å—å"""
    context = _create_context(user_context)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
    _check_access(entity_name, "write", context)
    
    handler = _registry.get_handler(entity_name, context, namespace)
    return handler.save(entity_name, data, context)

def uma_delete(
    entity_name: str,
    id_value: Any,
    user_context: Any = None,
    namespace: str = "default"
) -> bool:
    """–£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å"""
    context = _create_context(user_context)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
    _check_access(entity_name, "delete", context)
    
    handler = _registry.get_handler(entity_name, context, namespace)
    return handler.delete(entity_name, id_value, context)

def uma_meta(
    entity_name: str,
    user_context: Any = None,
    namespace: str = "default"
) -> dict:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏"""
    context = _create_context(user_context)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
    _check_access(entity_name, "meta", context)
    
    handler = _registry.get_handler(entity_name, context, namespace)
    return handler.meta(entity_name, context)

def uma_list_entities(
    user_context: Any = None,
    namespace: str = "default"
) -> list[str]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π.
    –†–µ–∑—É–ª—å—Ç–∞—Ç –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –≤ MetadataProvider.
    """
    context = _create_context(user_context)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø–æ–ª—É—á–µ–Ω–∏—é —Å–ø–∏—Å–∫–∞
    _check_access("", "meta", context)
    
    return context.metadata_provider.list_entities(context, namespace)
```

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```python
from sqlalchemy import create_engine, MetaData

# ========== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ==========

engine = create_engine("postgresql://...")
metadata = MetaData()
metadata.reflect(bind=engine)

# –°–æ–∑–¥–∞—ë–º –∫–∞—Å—Ç–æ–º–Ω—ã–π MetadataProvider —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤
class MyMetadataProvider(DefaultMetadataProvider):
    def can(self, entity_name: str, operation: Operation, context: UMAContext) -> bool:
        user = context.user_context
        
        # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–ª—É—á–∞–π: —Å–ø–∏—Å–æ–∫ —Å—É—â–Ω–æ—Å—Ç–µ–π
        if entity_name == "" and operation == "meta":
            return user is not None  # –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if not user:
            return False
        
        user_role = getattr(user, "role", "guest")
        
        # –ü—Ä–∏–º–µ—Ä –ª–æ–≥–∏–∫–∏ –ø—Ä–∞–≤
        if user_role == "admin":
            return True  # –ê–¥–º–∏–Ω—É –≤—Å—ë –º–æ–∂–Ω–æ
        elif user_role == "user":
            # –û–±—ã—á–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: read/list - –¥–∞, write/delete - –Ω–µ—Ç
            return operation in ("list", "read", "meta")
        else:
            return False

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º UMA
registry = initialize_uma(
    engine,
    metadata,
    metadata_provider=MyMetadataProvider(None)  # registry –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
)
MyMetadataProvider(_registry)  # –ü–µ—Ä–µ–¥–∞—ë–º registry –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä

# ========== –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è handlers ==========

# 1. –û–±—ã—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –≤—ã–±–æ—Ä–∫–∏
class RestrictedUserHandler(DefaultEntityHandler):
    @staticmethod
    def select(entity_name: str, params: dict[str, Any], context: UMAContext) -> Select:
        from sqlalchemy import select
        table = context.metadata.tables[entity_name]
        query = select(table).where(table.c.active == True)
        return query

registry.register("users", RestrictedUserHandler)

# 2. –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
registry.register("user_summary", UserSummaryView)

# 3. –ö–∞—Å—Ç–æ–º–Ω—ã–π handler –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
class LoggingDefaultHandler(DefaultEntityHandler):
    @staticmethod
    def select(entity_name: str, params: dict[str, Any], context: UMAContext) -> Select:
        print(f"[LOG] Selecting from {entity_name}")
        return DefaultEntityHandler.select(entity_name, params, context)

registry.set_default_handler(LoggingDefaultHandler)

# ========== –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ==========

# –°–æ–∑–¥–∞—ë–º user context
class User:
    def __init__(self, id, role):
        self.id = id
        self.role = role

current_user = User(id=123, role="user")

# 1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å—É—â–Ω–æ—Å—Ç–µ–π
try:
    entities = uma_list_entities(user_context=current_user)
    print(f"Available entities: {entities}")
except UmaAccessDeniedError as e:
    print(f"Access denied: {e}")

# 2. –ß—Ç–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
user = uma_read("users", 456, user_context=current_user)

# 3. JSQL –∑–∞–ø—Ä–æ—Å —Å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º (–±—É–¥–µ—Ç CTE)
jsql = {
    "select": ["*"],
    "from": "user_summary",
    "params": {"user_id": 123}
}
summary = uma_select(jsql, user_context=current_user)

# 4. –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø–∏—Å–∏ (–±—É–¥–µ—Ç UmaAccessDeniedError –¥–ª—è role="user")
try:
    uma_save("users", {"id": 456, "name": "New Name"}, user_context=current_user)
except UmaAccessDeniedError as e:
    print(f"Cannot save: {e}")
```

## 3. –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### ‚úÖ –†–µ—à—ë–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã:

1. **–ï–¥–∏–Ω—ã–π EntityHandler** - –Ω–µ—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
2. **MetadataProvider.can()** - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
3. **MetadataProvider.list_entities()** - –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
4. **Namespace** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `<namespace>:<entity_name>`
5. **is_virtual_view** - –∞—Ç—Ä–∏–±—É—Ç –∫–ª–∞—Å—Å–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏
6. **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è CTE** - —á–µ—Ä–µ–∑ `context.get_or_create_cte()`
7. **–Ø–≤–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** - `UMAContext` –≤ –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤
8. **set_default_handler()** - —è–≤–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

### üí° –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

1. **–ì–∏–±–∫–æ—Å—Ç—å**: MetadataProvider –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–ª—è –ª—é–±–æ–π –ª–æ–≥–∏–∫–∏ –ø—Ä–∞–≤ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
2. **–ß–∏—Å—Ç–æ—Ç–∞**: Stateless handlers, —è–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å—É—â–Ω–æ—Å—Ç–µ–π, –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è CTE
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —á–µ—Ä–µ–∑ `can()`
5. **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: Fallback –Ω–∞ default handler –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç boilerplate

### ü§î –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è:

1. **–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**: –•–æ—Ç–∏—Ç–µ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `contextvars` –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ `UMAContext` –Ω–µ—è–≤–Ω–æ? –≠—Ç–æ —É–ø—Ä–æ—Å—Ç–∏—Ç —Å–∏–≥–Ω–∞—Ç—É—Ä—ã, –Ω–æ —Å–¥–µ–ª–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–Ω–µ–µ —è–≤–Ω—ã–º–∏.

2. **–§–æ—Ä–º–∞—Ç namespace**: `<namespace>:<name>` –∏–ª–∏ –º–æ–∂–Ω–æ –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç? –ù–∞–ø—Ä–∏–º–µ—Ä `<namespace>.<name>` –∏–ª–∏ `<namespace>/<name>`?

3. **–ö—ç—à TTL**: 5 –º–∏–Ω—É—Ç –¥–ª—è –∫—ç—à–∞ —Å–ø–∏—Å–∫–∞ —Å—É—â–Ω–æ—Å—Ç–µ–π - –ø–æ–¥—Ö–æ–¥–∏—Ç? –î–æ–ª–∂–µ–Ω –ª–∏ –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º?

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ is_virtual_view**: –°–µ–π—á–∞—Å —á–µ—Ä–µ–∑ –∞—Ç—Ä–∏–±—É—Ç –∫–ª–∞—Å—Å–∞. –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `EntityHandler.is_virtual_view()` –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è?

5. **–ü–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤**: –°–µ–π—á–∞—Å –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ API —Ñ—É–Ω–∫—Ü–∏—è—Ö (`uma_read`, `uma_save`, etc.). –ù—É–∂–Ω–∞ –ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω—É—Ç—Ä–∏ handlers?

–ì–æ—Ç–æ–≤ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É - –Ω–∞—á–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–¥–∞ –∏–ª–∏ –æ–±—Å—É–¥–∏—Ç—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –¥–µ—Ç–∞–ª–∏!

---

**User**

(20260104-020125) (20260104-140013)

(20260104-131512) (–í–ê–ñ–ù–û!) –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–º–∏ –≤–æ –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ —Å–ª–µ–¥—É–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.

(20260104-020952)
> ```python
> class EntityHandler(Protocol):
>     # –ê—Ç—Ä–∏–±—É—Ç—ã –∫–ª–∞—Å—Å–∞ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
>     is_virtual_view: bool = False
> ```

–Ø –¥—É–º–∞—é, `is_virtual_view` –ª—É—á—à–µ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö, –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ —ç—Ç–æ—Ç –∞—Ç—Ä–∏–±—É—Ç –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç.

(20260104-020956)
> –†–µ–∞–ª–∏–∑–∞—Ü–∏—è DefaultEntityHandler

–•–º... –í –º–µ—Ç–æ–¥–µ `save` –≤–∏–∂—É —Ç–∞–∫–æ–µ:
```
else:
    # UPDATE
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
    existing = DefaultEntityHandler.read(entity_name, id_value, context)
    if existing is None:
        raise UmaAccessDeniedError(
            entity_name,
            "write",
            f"No access to update {entity_name}:{id_value}"
        )

```
(.1) –≠—Ç–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –û—Ç `DefaultEntityHandler` –≤ –ø—Ä–æ–µ–∫—Ç–µ –±—É–¥—É—Ç –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å, –±—É–¥—É—Ç –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å –∏ `read` –∏ `select`.
–ó–¥–µ—Å—å –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –±—ã–ª –≤—ã–∑–≤–∞–Ω `read` —Ç–æ–≥–æ –∂–µ –∫–ª–∞—Å—Å–∞, –∫–æ—Ç–æ—Ä–æ–º—É –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç `save`.
–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, `@staticmethod` –¥–ª—è UMA-–æ–ø–µ—Ä–∞—Ü–∏–π –≤ `EntityHandler` –Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –º–Ω–µ —Ö–æ—Ä–æ—à–µ–π –∏–¥–µ–µ–π. –î—É–º–∞—é, —ç—Ç–∏ –º–µ—Ç–æ–¥—ã —Å–ª–µ–¥—É–µ—Ç –¥–µ–∫–æ—Ä–∏—Ä–æ–≤–∞—Ç—å `classmethod`. –ß—Ç–æ —Å–∫–∞–∂–µ—à—å?

(.2) `read` –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å `None`: —ç—Ç–∞ –∏ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É ‚Äì –∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã (—Ç–µ–ª–æ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏ –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ), –∏–ª–∏ –≤—ã–±—Ä–æ—Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –≤–æ–∑–Ω–∏–∫—à–µ–π –ø—Ä–æ–±–ª–µ–º–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è.

(.3) –≠—Ç–æ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç –∫–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–π —è –ø—Ä–æ—Ü–∏—Ç–∏—Ä–æ–≤–∞–ª –≤—ã—à–µ —É —Ç–µ–±—è –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è (–Ω–∏–∂–µ, –≤ `delete`), —á—Ç–æ —Å–æ–≤—Å–µ–º –Ω–µ –µ—Å—Ç—å —Ö–æ—Ä–æ—à–æ.

(20260104-022042)
```python
class UserSummaryView:
    ... ... ...
    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    columns_metadata = [
        {"name": "user_id", "type": "integer", "description": "ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"},
        {"name": "name", "type": "string", "description": "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"},
        {"name": "order_count", "type": "integer", "description": "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤"},
        {"name": "total_spent", "type": "numeric", "description": "–û–±—â–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–æ–≤"}
    ]
```
–ü–æ-–º–æ–µ–º—É, –∑–¥–µ—Å—å –ø—Ä–∏–≥–æ–¥–∏–ª–∏—Å—å –±—ã —É–¥–æ–±–Ω—ã–µ —Å–µ—Ä–≤–∏—Å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–∑–≤–æ–ª–∏–ª–∏ –±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—è –∏–∑ –¥—Ä—É–≥–æ–π —Å—É—â–Ω–æ—Å—Ç–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–¥–µ—Ä–∂–∞—â–µ–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ:
```python
    columns_metadata = [
        ... ... ...
        copy_field_meta('users', 'name'),
        ... ... ...
    ]
```

(20260104-124447)
> –ü—Ä–∏–º–µ—Ä –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è

```python
class UserSummaryView:
    ... ... ...
    def save(entity_name: str, data: dict, context: UMAContext) -> Any:
        """–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ - read-only"""
        raise UmaAccessDeniedError(entity_name, "write", "Virtual view is read-only")
```
–î—É–º–∞—é, —Ç–∞–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (–≤—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å `UmaAccessDeniedError`/`UmaNotImplementedError` —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π, –æ–ø–∏—Å—ã–≤–∞—é—â–µ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç) —Å–ª–µ–¥—É–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ –±–∞–∑–æ–≤–æ–º –∫–ª–∞—Å—Å–µ –¥–ª—è Entity Handlers. –ò–ª–∏ –≤ –±–∞–∑–æ–≤–æ–º –∫–ª–∞—Å—Å–µ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π, –ø–æ—Å–∫–æ–ª—å–∫—É, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ, `read` –∏ CRUD-–º–µ—Ç–æ–¥—ã —Ç–∞–º —á–∞—â–µ –≤—Å–µ–≥–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –Ω–µ –±—É–¥—É—Ç, –∏ –Ω–µ —Ö–æ—á–µ—Ç—Å—è –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥, –ø–æ–≤—Ç–æ—Ä—è—è—Å—å —Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π —ç—Ç–∏—Ö –º–µ—Ç–æ–¥–æ–≤ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º—É, —á—Ç–æ –æ–Ω–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ `EntityHandler`.

(20260104-125753)
```python
        # –†–∞–∑–±–∏—Ä–∞–µ–º entity_name
        if ":" in entity_name:
            # –Ø–≤–Ω–æ —É–∫–∞–∑–∞–Ω namespace
            full_name = entity_name
            _, pure_name = entity_name.split(":", 1)
        else:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º namespace –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            full_name = f"{namespace}:{entity_name}"
            pure_name = entity_name
```
–î—É–º–∞—é, —ç—Ç–æ—Ç –∫–æ–¥ —è–≤–ª—è–µ—Ç—Å—è —Å–∞–º–æ—Ü–µ–Ω–Ω—ã–º, –∏ –µ–≥–æ —Å–ª–µ–¥—É–µ—Ç –≤—ã–Ω–µ—Å—Ç–∏ –≤ —Ñ—É–Ω–∫—Ü–∏—é `parse_entity_name`, –≤–æ–∑–≤—Ä–∞—â–∞—é—â—É—é dataclass, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π `workspace` –∏ `entity` ‚Äì —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∏–º—ë–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Ö–µ–º–∞ –≤ PostgreSQL) –∏ –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏ –≤ –Ω—ë–º.
–î–∞–ª–µ–µ, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é `form_entity_name`, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å —ç—Ç–æ—Ç dataclass –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞, –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ, –æ—Ç—Ä–∞–∂–∞—é—â–µ–µ –Ω–∞—à–∏ –ø—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–º–µ–Ω–∏: `<workspace>:<entity>`.

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ, –ø—Ä–µ–¥–ª–∞–≥–∞—é —Å—á–∏—Ç–∞—Ç—å –∑–∞–ø–∏—Å—å `default:users` –∏ `users` —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω—ã–º–∏. –≠—Ç–æ –∏–∑–±–∞–≤–∏—Ç—å –æ—Ç –±–æ–π–ª–µ—Ä–ø–ª–µ–π—Ç–∞ –≤ –æ–±—ã—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö.

(20260104-133346)
```python
    def can(
        self,
        entity_name: str,
        operation: Operation,
        context: UMAContext
    ) -> bool:
```
–° –±–∞–∑–æ–≤–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π `can` —è —Å–æ–≥–ª–∞—Å–µ–Ω, –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ, –ø—Ä–µ–¥–ª–∞–≥–∞—é –∑–∞–º–µ–Ω–∏—Ç—å `entity_name` ‚Üí `target`, —á—Ç–æ–±—ã –∏–º–µ—Ç—å —Å–≤–æ–±–æ–¥—É —Ç—Ä–∞–∫—Ç–æ–≤–∫–∏ —ç—Ç–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞: –≤ –∫–æ–Ω—Ü–µ –∫–æ–Ω—Ü–æ–≤, –º—ã –Ω–µ —É–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏, –∫–æ–≥–¥–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª–Ω–æ–º–æ—á–∏—è –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é —ç—Ç–∏—Ö –∏–º—ë–Ω.

(20260104-133844)
> ü§î –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è:
> –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: –•–æ—Ç–∏—Ç–µ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å contextvars –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ UMAContext –Ω–µ—è–≤–Ω–æ? –≠—Ç–æ —É–ø—Ä–æ—Å—Ç–∏—Ç —Å–∏–≥–Ω–∞—Ç—É—Ä—ã, –Ω–æ —Å–¥–µ–ª–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–Ω–µ–µ —è–≤–Ω—ã–º–∏.

–î–∞–≤–∞–π –ø–æ–∫–∞ –±–µ–∑ context vars... –ù–µ –ª—é–±–ª—é –º–∞–≥–∏—é. –Ø–≤–Ω–æ–µ –ª—É—á—à–µ –Ω–µ—è–≤–Ω–æ–≥–æ ‚ìí

> –§–æ—Ä–º–∞—Ç namespace: <namespace>:<name> –∏–ª–∏ –º–æ–∂–Ω–æ –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç? –ù–∞–ø—Ä–∏–º–µ—Ä <namespace>.<name> –∏–ª–∏ <namespace>/<name>?

–î—É–º–∞—é, —è –æ—Ç–≤–µ—Ç–∏–ª –≤—ã—à–µ, –≤ —Ä–∞–∑–¥–µ–ª–µ `(20260104-125753)`. –°–ª—ç—à –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –∞–ª—å—Ç–µ–Ω–∞—Ç–∏–≤–∞, –≤–æ–∑–º–æ–∂–Ω–æ –º—ã –∫ –Ω–µ–π –≤–µ—Ä–Ω—ë–º—Å—è, –Ω–æ –ø–æ–∑–∂–µ, –∏ –≤ –¥—Ä—É–≥–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.

> –ö—ç—à TTL: 5 –º–∏–Ω—É—Ç –¥–ª—è –∫—ç—à–∞ —Å–ø–∏—Å–∫–∞ —Å—É—â–Ω–æ—Å—Ç–µ–π - –ø–æ–¥—Ö–æ–¥–∏—Ç? –î–æ–ª–∂–µ–Ω –ª–∏ –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º?

–î—É–º–∞—é, –Ω–∞ —Ç–µ–∫—É—â–µ–º —ç—Ç–∞–ø–µ –º–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏—Å—å –±–µ–∑ TTL. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –º–µ–Ω—è–µ—Ç—Å—è —Ä–µ–¥–∫–æ (–æ–±—ã—á–Ω–æ deploy), –≤ —ç—Ç–∏—Ö —Å–ª—É—á–∞—è—Ö –º–æ–∂–µ—Ç –æ–∫–∞–∑–∞—Ç—å—Å—è –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—ã–º —Ä–µ—à–µ–Ω–∏–µ–º –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä–≤–∏—Å.

> –ü—Ä–æ–≤–µ—Ä–∫–∞ is_virtual_view: –°–µ–π—á–∞—Å —á–µ—Ä–µ–∑ –∞—Ç—Ä–∏–±—É—Ç –∫–ª–∞—Å—Å–∞. –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ EntityHandler.is_virtual_view() –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è?

–î—É–º–∞—é, –∏–∑ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –∫–ª–∞—Å—Å–∞ —ç—Ç–æ —Å–ª–µ–¥—É–µ—Ç —É–±—Ä–∞—Ç—å, –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ —Å–¥–µ–ª–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏: –¥–æ–ª–∂–µ–Ω –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∞—Ç—Ä–∏–±—É—Ç `is_virtual_view`, –∏ –æ–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ `True`, —á—Ç–æ–±—ã —Å—É—â–Ω–æ—Å—Ç—å —Å—á–∏—Ç–∞–ª–∞—Å—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º.
–ö—Ä–æ–º–µ —Ç–æ–≥–æ, –¥–ª—è entity handlers –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –æ–±–µ—Å–ø–µ—á–∏—Ç –ø–æ—è–≤–ª–µ–Ω–∏–µ –≤ –º–µ—Ç–∞–¥–∞–∂–Ω–Ω—ã—Ö —ç—Ç–æ–≥–æ –∞—Ç—Ä–∏–±—É—Ç–∞.

> –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤: –°–µ–π—á–∞—Å –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ API —Ñ—É–Ω–∫—Ü–∏—è—Ö (uma_read, uma_save, etc.). –ù—É–∂–Ω–∞ –ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω—É—Ç—Ä–∏ handlers?

–°–µ–π—á–∞—Å –Ω–µ—Ç. –°–µ–π—á–∞—Å –º–Ω–µ –∏–∑–≤–µ—Å—Ç–Ω–æ –ø–æ —Ç–µ–º–µ —Å–ª–µ–¥—É—é—â–µ–µ:
1) –û–ø—Ä–µ–¥–µ–ª—è—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç–µ entity handlers –∏ `can` ‚Äì –ª–µ–≥–∏—Ç–∏–º–Ω—ã–π –ø—É—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è UMA "—Å–Ω–∞—Ä—É–∂–∏".
2) –í –º–µ—Ç–æ–¥–∞—Ö –ø—Ä–æ–µ–∫—Ç–Ω—ã—Ö entity handlers –Ω–æ—Ä–º–∞–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å `can` –∏–∑ UMA, –Ω–æ —Ç–∞–º –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –∏ –ø—Ä–æ–µ–∫—Ç–Ω—ã–π `can` —Å –¥—Ä—É–≥–∏–º –Ω–∞–±–æ—Ä–æ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `user_id`, –ø—Ä–∞–≤–∏–ª–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –∑–∞ —Ä–∞–º–∫–∞–º–∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π UMA) –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ—Ç–æ—Ä—ã—Ö –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç.
3) –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, –Ω–∞–º –Ω—É–∂–µ–Ω –º–µ—Ö–∞–Ω–∏–∑–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è `Context` UMA, –Ω–æ —ç—Ç–∏–º –∑–∞–π–º—ë–º—Å—è –ø–æ–∑–∂–µ.
4) –û–±—Ä–∞—â–∞—Ç—å—Å—è –∫ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ entity handlers –∏–∑ –ø—Ä–æ–µ–∫—Ç–Ω–æ–≥–æ –∫–æ–¥–∞ –Ω–∞–ø—Ä—è–º—É—é (–Ω–µ —á–µ—Ä–µ–∑ –æ–±—ë—Ä—Ç–∫–∏ –≤—Ä–æ–¥–µ `uma_save`) ‚Äì —Å–æ–∑–¥–∞–≤–∞—Ç—å –±—Ä–µ—à—å –≤ —Å–∏—Å—Ç–µ–º–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ —Å–µ–π—á–∞—Å –¥–ª—è –º–µ–Ω—è —ç—Ç–æ –∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω.
5) –ù–∞–≥—Ä—É–∂–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –ø–æ–ª–Ω–æ–º–æ—á–∏–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é entity handlers –≤ UMA ‚Äì –ø—Ä–æ–≤–æ—Ü–∏—Ä–æ–≤–∞—Ç—å "–≥–æ–Ω–∫—É" –ø—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–Ω—ã—Ö entity handlers, –ø–æ—Å–∫–æ–ª—å–∫—É –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–µ—â–∏ –Ω–∞–≤–µ—Ä–Ω—è–∫–∞ –∑–∞—Ö–æ—á–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–∞–∫ –¥–æ, —Ç–∞–∫ –∏ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª–Ω–æ–º–æ—á–∏–π, –∞ –æ —Ç–æ–º, –∫–∞–∫–æ–≤–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —ç—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ ‚Äì –Ω–∞ —É—Ä–æ–≤–Ω–µ UMA –º—ã –∑–Ω–∞—Ç—å –Ω–µ –∑–Ω–∞–µ–º.
‚Äî

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏ —Å–≤–æ–∏ –≤–æ–ø—Ä–æ—Å—ã, –ø–æ–¥—Å–≤–µ—Ç–∫—É —Ä–∏—Å–∫–æ–≤ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤ —Å–≤–µ—Ç–µ –æ–±–æ–∑–Ω–∞—á–µ–Ω–Ω–æ–≥–æ –≤—ã—à–µ.


---

**Cursor**

–û—Ç–ª–∏—á–Ω–æ! –ü—Ä–∏–Ω–∏–º–∞—é –≤—Å–µ –∑–∞–º–µ—á–∞–Ω–∏—è. –°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ - **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**. –î–∞–≤–∞–π—Ç–µ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–∏–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å —É—á—ë—Ç–æ–º –≤—Å–µ—Ö —É—Ç–æ—á–Ω–µ–Ω–∏–π.

## –ü–µ—Ä–µ—Å–º–æ—Ç—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Å —É—á—ë—Ç–æ–º async –∏ –∑–∞–º–µ—á–∞–Ω–∏–π

### 1. –ò—Å–∫–ª—é—á–µ–Ω–∏—è UMA

```python
class UmaError(Exception):
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏–π UMA"""
    pass

class UmaAccessDeniedError(UmaError, PermissionError):
    """–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫–∞–∑–µ –≤ –¥–æ—Å—Ç—É–ø–µ"""
    def __init__(self, target: str, operation: str, message: str = None):
        self.target = target
        self.operation = operation
        super().__init__(message or f"Access denied to {operation} on {target}")

class UmaNotFoundError(UmaError, ValueError):
    """–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–≥–¥–∞ —Å—É—â–Ω–æ—Å—Ç—å/–∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"""
    def __init__(self, target: str, message: str = None):
        self.target = target
        super().__init__(message or f"Not found: {target}")

class UmaNotImplementedError(UmaError, NotImplementedError):
    """–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–∏"""
    def __init__(self, target: str, operation: str, message: str = None):
        self.target = target
        self.operation = operation
        super().__init__(message or f"Operation {operation} not implemented for {target}")
```

### 2. –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏

```python
from dataclasses import dataclass
from typing import Optional

@dataclass(frozen=True)
class EntityName:
    """
    –ö–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏.
    –§–æ—Ä–º–∞—Ç: <namespace>:<entity>
    """
    namespace: str
    entity: str
    
    def __str__(self) -> str:
        """–°—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ namespace:entity"""
        return form_entity_name(self)
    
    @property
    def is_default_namespace(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ namespace –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º"""
        return self.namespace == "default"

def parse_entity_name(name: str, default_namespace: str = "default") -> EntityName:
    """
    –ü–∞—Ä—Å–∏—Ç –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏.
    
    Args:
        name: –∏–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ "namespace:entity" –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ "entity"
        default_namespace: namespace –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω –≤ name)
        
    Returns:
        EntityName —Å —Ä–∞–∑–æ–±—Ä–∞–Ω–Ω—ã–º namespace –∏ entity
        
    Examples:
        parse_entity_name("users") -> EntityName(namespace="default", entity="users")
        parse_entity_name("default:users") -> EntityName(namespace="default", entity="users")
        parse_entity_name("schema1:users") -> EntityName(namespace="schema1", entity="users")
    """
    if ":" in name:
        namespace, entity = name.split(":", 1)
        return EntityName(namespace=namespace, entity=entity)
    else:
        return EntityName(namespace=default_namespace, entity=name)

def form_entity_name(entity_name: EntityName, omit_default: bool = True) -> str:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–º–µ–Ω–∏.
    
    Args:
        entity_name: –æ–±—ä–µ–∫—Ç EntityName
        omit_default: –µ—Å–ª–∏ True, —Ç–æ –¥–ª—è default namespace –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ—Å—Ç–æ entity
        
    Returns:
        –°—Ç—Ä–æ–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "namespace:entity" –∏–ª–∏ "entity" (–¥–ª—è default namespace)
        
    Examples:
        form_entity_name(EntityName("default", "users")) -> "users"
        form_entity_name(EntityName("default", "users"), omit_default=False) -> "default:users"
        form_entity_name(EntityName("schema1", "users")) -> "schema1:users"
    """
    if omit_default and entity_name.namespace == "default":
        return entity_name.entity
    return f"{entity_name.namespace}:{entity_name.entity}"
```

### 3. –¢–∏–ø—ã –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã (async)

```python
from typing import Protocol, Any, runtime_checkable, Literal
from sqlalchemy.ext.asyncio import AsyncEngine, AsyncConnection
from sqlalchemy import MetaData, Select

Operation = Literal["list", "read", "write", "delete", "meta"]

# ================== MetadataProvider (async) ==================

@runtime_checkable
class MetadataProvider(Protocol):
    """
    –ü—Ä–æ–≤–∞–π–¥–µ—Ä –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏ –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞.
    –í—Å–µ –º–µ—Ç–æ–¥—ã –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ.
    """
    
    async def get_metadata(self, entity_name: EntityName, context: 'UMAContext') -> dict:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏.
        –ú–æ–∂–µ—Ç –æ–±–æ–≥–∞—â–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (–ë–î, Redis, –∫–æ–Ω—Ñ–∏–≥).
        """
        ...
    
    async def list_entities(self, context: 'UMAContext', namespace: str = "default") -> list[str]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ <namespace>:<entity>.
        –†–µ–∑—É–ª—å—Ç–∞—Ç –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º.
        """
        ...
    
    async def can(
        self,
        target: str,  # entity_name –∏–ª–∏ "" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–ø–∏—Å–∫–∞
        operation: Operation,
        context: 'UMAContext'
    ) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –æ–ø–µ—Ä–∞—Ü–∏–∏.
        
        Args:
            target: –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏ (–∏–ª–∏ "" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–ø–∏—Å–∫—É)
            operation: —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ (list/read/write/delete/meta)
            context: –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            
        Returns:
            True –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω
            
        Raises:
            UmaAccessDeniedError –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω
            
        –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏:
        - target="" + operation="meta" -> –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–ø–∏—Å–∫—É —Å—É—â–Ω–æ—Å—Ç–µ–π
        """
        ...

# ================== Context (async) ==================

@dataclass
class UMAContext:
    """
    –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è UMA –æ–ø–µ—Ä–∞—Ü–∏–π.
    –ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –º–µ—Ç–æ–¥–æ–≤ EntityHandler.
    """
    engine: AsyncEngine
    metadata: MetaData
    metadata_provider: MetadataProvider
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤)
    user_context: Any = None
    
    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫—ç—à
    cache: Any = None
    
    # –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è CTE (–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è)
    _cte_cache: dict[str, Any] = field(default_factory=dict)
    
    def get_or_create_cte(self, entity_name: EntityName, select_fn) -> Any:
        """
        –ü–æ–ª—É—á–∞–µ—Ç CTE –∏–∑ –∫—ç—à–∞ –∏–ª–∏ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π.
        –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é CTE –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π.
        
        Args:
            entity_name: –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏
            select_fn: —Ñ—É–Ω–∫—Ü–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∞—è Select (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ CTE –Ω–µ—Ç –≤ –∫—ç—à–µ)
        """
        key = str(entity_name)
        if key not in self._cte_cache:
            select_query = select_fn()
            self._cte_cache[key] = select_query.cte(name=entity_name.entity)
        return self._cte_cache[key]

# ================== EntityHandler Protocol (async, classmethod) ==================

@runtime_checkable
class EntityHandler(Protocol):
    """
    –ü—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å—É—â–Ω–æ—Å—Ç–µ–π.
    –í—Å–µ –º–µ—Ç–æ–¥—ã –∫–ª–∞—Å—Å–æ–≤—ã–µ (@classmethod) - —ç—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –º–µ—Ç–æ–¥—ã —Å–≤–æ–µ–≥–æ –∫–ª–∞—Å—Å–∞ –ø—Ä–∏ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏.
    –í—Å–µ –º–µ—Ç–æ–¥—ã –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ.
    """
    
    @classmethod
    async def select(
        cls,
        entity_name: EntityName,
        params: dict[str, Any],
        context: UMAContext
    ) -> Select:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç SQLAlchemy Select –¥–ª—è –≤—ã–±–æ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö.
        –ò–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞ (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å—Ç—Ä–æ–∫).
        
        Note:
            –ü–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ context.metadata_provider.can()
        """
        ...
    
    @classmethod
    async def read(
        cls,
        entity_name: EntityName,
        id_value: Any,
        context: UMAContext
    ) -> dict:
        """
        –ß–∏—Ç–∞–µ—Ç –æ–¥–Ω—É –∑–∞–ø–∏—Å—å –ø–æ id.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç select() –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫ –¥–æ—Å—Ç—É–ø–∞.
        
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –∑–∞–ø–∏—Å–∏
            
        Raises:
            UmaNotFoundError –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞
            
        Note:
            –ü–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ context.metadata_provider.can()
        """
        ...
    
    @classmethod
    async def save(
        cls,
        entity_name: EntityName,
        data: dict,
        context: UMAContext
    ) -> Any:
        """
        –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–ø–∏—Å—å (create –µ—Å–ª–∏ id=None, –∏–Ω–∞—á–µ update).
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç id —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏.
        
        Raises:
            UmaNotImplementedError –µ—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
            
        Note:
            –ü–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ context.metadata_provider.can()
        """
        ...
    
    @classmethod
    async def delete(
        cls,
        entity_name: EntityName,
        id_value: Any,
        context: UMAContext
    ) -> bool:
        """
        –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –ø–æ id.
        
        Returns:
            True –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞
            
        Raises:
            UmaNotFoundError –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞
            UmaNotImplementedError –µ—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
            
        Note:
            –ü–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ context.metadata_provider.can()
        """
        ...
    
    @classmethod
    async def meta(
        cls,
        entity_name: EntityName,
        context: UMAContext
    ) -> dict:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏.
        –ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å context.metadata_provider –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö.
        
        Note:
            –ü–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ context.metadata_provider.can()
        """
        ...
```

### 4. –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏

```python
async def copy_field_meta(
    source_entity: str | EntityName,
    field_name: str,
    context: UMAContext,
    overrides: dict = None
) -> dict:
    """
    –ö–æ–ø–∏—Ä—É–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—è –∏–∑ –¥—Ä—É–≥–æ–π —Å—É—â–Ω–æ—Å—Ç–∏.
    
    Args:
        source_entity: –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏-–∏—Å—Ç–æ—á–Ω–∏–∫–∞
        field_name: –∏–º—è –ø–æ–ª—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        context: –∫–æ–Ω—Ç–µ–∫—Å—Ç UMA
        overrides: —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤
        
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—è
        
    Example:
        columns_metadata = [
            await copy_field_meta('users', 'id', context),
            await copy_field_meta('users', 'name', context, {'description': '–ò–º—è –≤ —Å–≤–æ–¥–∫–µ'}),
            {"name": "order_count", "type": "integer", "description": "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤"}
        ]
    """
    if isinstance(source_entity, str):
        source_entity = parse_entity_name(source_entity)
    
    # –ü–æ–ª—É—á–∞–µ–º handler –∏—Å—Ç–æ—á–Ω–∏–∫–∞
    from .registry import get_global_registry  # –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –ø–æ–∑–∂–µ
    registry = get_global_registry()
    handler = registry.get_handler(source_entity, context)
    
    # –ü–æ–ª—É—á–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    source_meta = await handler.meta(source_entity, context)
    
    # –ò—â–µ–º –ø–æ–ª–µ
    for col in source_meta.get("columns", []):
        if col["name"] == field_name:
            result = col.copy()
            if overrides:
                result.update(overrides)
            return result
    
    raise ValueError(f"Field {field_name} not found in {source_entity}")

def is_virtual_view(metadata: dict) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—É—â–Ω–æ—Å—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º.
    
    Args:
        metadata: —Å–ª–æ–≤–∞—Ä—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–∏
        
    Returns:
        True –µ—Å–ª–∏ is_virtual_view –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏ —Ä–∞–≤–µ–Ω True
    """
    return metadata.get("is_virtual_view", False) is True
```

### 5. –ë–∞–∑–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã EntityHandler

```python
class DefaultEntityHandler:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –ë–î.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ fallback –¥–ª—è –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π.
    """
    
    @classmethod
    async def select(
        cls,
        entity_name: EntityName,
        params: dict[str, Any],
        context: UMAContext
    ) -> Select:
        """–ü—Ä–æ—Å—Ç–æ–π SELECT * FROM table"""
        from sqlalchemy import select
        
        table = context.metadata.tables[entity_name.entity]
        query = select(table)
        
        return query
    
    @classmethod
    async def read(
        cls,
        entity_name: EntityName,
        id_value: Any,
        context: UMAContext
    ) -> dict:
        """
        –ß—Ç–µ–Ω–∏–µ —á–µ—Ä–µ–∑ select + —Ñ–∏–ª—å—Ç—Ä –ø–æ id.
        –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None - –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç UmaNotFoundError.
        """
        # –ü–æ–ª—É—á–∞–µ–º select (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ –ø–æ–¥–∫–ª–∞—Å—Å–µ —Å –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏)
        query = await cls.select(entity_name, {}, context)
        
        # –î–æ–±–∞–≤–ª—è–µ–º —É—Å–ª–æ–≤–∏–µ –ø–æ id
        table = context.metadata.tables[entity_name.entity]
        pk_columns = list(table.primary_key.columns)
        
        if len(pk_columns) == 1:
            query = query.where(pk_columns[0] == id_value)
        else:
            from sqlalchemy import and_
            conditions = [col == val for col, val in zip(pk_columns, id_value)]
            query = query.where(and_(*conditions))
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º
        async with context.engine.connect() as conn:
            result = await conn.execute(query)
            row = result.mappings().first()
            
            if row is None:
                raise UmaNotFoundError(
                    str(entity_name),
                    f"Record with id={id_value} not found or access denied"
                )
            
            return dict(row)
    
    @classmethod
    async def save(
        cls,
        entity_name: EntityName,
        data: dict,
        context: UMAContext
    ) -> Any:
        """
        –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü—É.
        –£–±—Ä–∞–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ - –æ–Ω–∞ –±—É–¥–µ—Ç –≤ _ensure_exists().
        """
        from sqlalchemy import insert, update
        
        table = context.metadata.tables[entity_name.entity]
        pk_columns = list(table.primary_key.columns)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º create vs update
        if len(pk_columns) == 1:
            id_value = data.get(pk_columns[0].name)
        else:
            id_value = tuple(data.get(col.name) for col in pk_columns)
        
        is_create = (id_value is None or (isinstance(id_value, tuple) and None in id_value))
        
        async with context.engine.begin() as conn:
            if is_create:
                # INSERT
                stmt = insert(table).values(**data)
                result = await conn.execute(stmt)
                
                if len(pk_columns) == 1:
                    return result.inserted_primary_key[0]
                else:
                    return tuple(result.inserted_primary_key)
            else:
                # UPDATE
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ read (DRY - –∏–∑–±–µ–≥–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
                await cls._ensure_exists(entity_name, id_value, context)
                
                # –°—Ç—Ä–æ–∏–º —É—Å–ª–æ–≤–∏–µ –ø–æ PK
                pk_condition = cls._build_pk_condition(pk_columns, id_value)
                
                stmt = update(table).where(pk_condition).values(**data)
                await conn.execute(stmt)
                return id_value
    
    @classmethod
    async def delete(
        cls,
        entity_name: EntityName,
        id_value: Any,
        context: UMAContext
    ) -> bool:
        """
        –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç _ensure_exists() –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ (DRY).
        """
        from sqlalchemy import delete as sql_delete
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ read (DRY)
        await cls._ensure_exists(entity_name, id_value, context)
        
        table = context.metadata.tables[entity_name.entity]
        pk_columns = list(table.primary_key.columns)
        pk_condition = cls._build_pk_condition(pk_columns, id_value)
        
        async with context.engine.begin() as conn:
            stmt = sql_delete(table).where(pk_condition)
            result = await conn.execute(stmt)
            return result.rowcount > 0
    
    @classmethod
    async def meta(
        cls,
        entity_name: EntityName,
        context: UMAContext
    ) -> dict:
        """–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ SQLAlchemy MetaData + –æ–±–æ–≥–∞—â–µ–Ω–∏–µ –∏–∑ MetadataProvider"""
        table = context.metadata.tables[entity_name.entity]
        
        columns = []
        for col in table.columns:
            col_info = {
                "name": col.name,
                "type": str(col.type),
                "nullable": col.nullable,
                "primary_key": col.primary_key,
            }
            
            # –í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏
            if col.foreign_keys:
                fk = list(col.foreign_keys)[0]
                col_info["related_to"] = fk.column.table.name
                col_info["related_key"] = fk.column.name
            
            columns.append(col_info)
        
        metadata = {
            "name": str(entity_name),
            "description": "",
            "columns": columns
        }
        
        # –û–±–æ–≥–∞—â–∞–µ–º –∏–∑ MetadataProvider
        try:
            provider_metadata = await context.metadata_provider.get_metadata(entity_name, context)
            metadata.update(provider_metadata)
        except Exception:
            pass
        
        return metadata
    
    # ========== –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã (DRY) ==========
    
    @classmethod
    async def _ensure_exists(
        cls,
        entity_name: EntityName,
        id_value: Any,
        context: UMAContext
    ) -> dict:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏ –¥–æ—Å—Ç—É–ø –∫ –Ω–µ–π —á–µ—Ä–µ–∑ read().
        –í—ã–Ω–µ—Å–µ–Ω–æ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤ save/delete.
        
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –∑–∞–ø–∏—Å–∏
            
        Raises:
            UmaNotFoundError –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞
        """
        return await cls.read(entity_name, id_value, context)
    
    @staticmethod
    def _build_pk_condition(pk_columns: list, id_value: Any):
        """
        –°—Ç—Ä–æ–∏—Ç —É—Å–ª–æ–≤–∏–µ WHERE –¥–ª—è –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞.
        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä–æ—Å—Ç—ã–µ –∏ —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∫–ª—é—á–∏.
        """
        if len(pk_columns) == 1:
            return pk_columns[0] == id_value
        else:
            from sqlalchemy import and_
            return and_(*[col == val for col, val in zip(pk_columns, id_value)])


class VirtualViewHandler:
    """
    –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π.
    –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏, –≤—ã–±—Ä–∞—Å—ã–≤–∞—é—â–∏–µ UmaNotImplementedError.
    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç is_virtual_view=True –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ.
    """
    
    @classmethod
    async def select(
        cls,
        entity_name: EntityName,
        params: dict[str, Any],
        context: UMAContext
    ) -> Select:
        """
        –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤ –ø–æ–¥–∫–ª–∞—Å—Å–µ.
        """
        raise UmaNotImplementedError(
            str(entity_name),
            "select",
            f"Virtual view {entity_name} must implement select()"
        )
    
    @classmethod
    async def read(
        cls,
        entity_name: EntityName,
        id_value: Any,
        context: UMAContext
    ) -> dict:
        """
        –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π.
        –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤ –ø–æ–¥–∫–ª–∞—Å—Å–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.
        """
        raise UmaNotImplementedError(
            str(entity_name),
            "read",
            f"Virtual view {entity_name} does not support read operation"
        )
    
    @classmethod
    async def save(
        cls,
        entity_name: EntityName,
        data: dict,
        context: UMAContext
    ) -> Any:
        """–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é read-only"""
        raise UmaNotImplementedError(
            str(entity_name),
            "write",
            f"Virtual view {entity_name} is read-only"
        )
    
    @classmethod
    async def delete(
        cls,
        entity_name: EntityName,
        id_value: Any,
        context: UMAContext
    ) -> bool:
        """–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é read-only"""
        raise UmaNotImplementedError(
            str(entity_name),
            "delete",
            f"Virtual view {entity_name} is read-only"
        )
    
    @classmethod
    async def meta(
        cls,
        entity_name: EntityName,
        context: UMAContext
    ) -> dict:
        """
        –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö.
        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç is_virtual_view=True.
        –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∞ –≤ –ø–æ–¥–∫–ª–∞—Å—Å–µ –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è columns.
        """
        return {
            "name": str(entity_name),
            "description": getattr(cls, "description", ""),
            "is_virtual_view": True,
            "columns": getattr(cls, "columns_metadata", [])
        }
```

### 6. –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```python
# ========== –ü—Ä–∏–º–µ—Ä –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è ==========

class UserSummaryView(VirtualViewHandler):
    """
    –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ: —Å–≤–æ–¥–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.
    """
    
    description = "–°–≤–æ–¥–∫–∞ –ø–æ –∑–∞–∫–∞–∑–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
    
    @classmethod
    async def select(
        cls,
        entity_name: EntityName,
        params: dict[str, Any],
        context: UMAContext
    ) -> Select:
        from sqlalchemy import select, func
        
        users = context.metadata.tables["users"]
        orders = context.metadata.tables["orders"]
        
        query = select(
            users.c.id.label("user_id"),
            users.c.name,
            func.count(orders.c.id).label("order_count"),
            func.coalesce(func.sum(orders.c.total), 0).label("total_spent")
        ).select_from(
            users.outerjoin(orders, users.c.id == orders.c.user_id)
        ).group_by(users.c.id, users.c.name)
        
        # –ü–æ–ª–∏—Ç–∏–∫–∞ –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ params
        if "user_id" in params:
            query = query.where(users.c.id == params["user_id"])
        
        return query
    
    @classmethod
    async def read(
        cls,
        entity_name: EntityName,
        id_value: Any,
        context: UMAContext
    ) -> dict:
        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º read –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —á—Ç–µ–Ω–∏—è –ø–æ user_id"""
        query = await cls.select(entity_name, {"user_id": id_value}, context)
        
        async with context.engine.connect() as conn:
            result = await conn.execute(query)
            row = result.mappings().first()
            
            if row is None:
                raise UmaNotFoundError(
                    str(entity_name),
                    f"User summary with id={id_value} not found"
                )
            
            return dict(row)
    
    @classmethod
    async def meta(
        cls,
        entity_name: EntityName,
        context: UMAContext
    ) -> dict:
        """–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º copy_field_meta()"""
        
        # –ú–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å copy_field_meta –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
        columns_metadata = [
            await copy_field_meta("users", "id", context, {"name": "user_id"}),
            await copy_field_meta("users", "name", context),
            {"name": "order_count", "type": "integer", "description": "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤"},
            {"name": "total_spent", "type": "numeric", "description": "–û–±—â–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–æ–≤"}
        ]
        
        return {
            "name": str(entity_name),
            "description": cls.description,
            "is_virtual_view": True,
            "columns": columns_metadata
        }
```

### 7. –í–æ–ø—Ä–æ—Å—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

**–í–æ–ø—Ä–æ—Å 1: –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è CTE –≤ PostgreSQL**

–í—ã –±—ã–ª–∏ –ø—Ä–∞–≤—ã - —ç—Ç–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞ PostgreSQL 12+, –Ω–µ –Ω—É–∂–Ω–æ –Ω–∞ –Ω–µ—ë –∑–∞–≤—è–∑—ã–≤–∞—Ç—å—Å—è. SQLAlchemy —Å–æ–∑–¥–∞—ë—Ç –æ–±—ã—á–Ω—ã–µ CTE, –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç –∫—Ä–æ—Å—Å-–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ.

**–í–æ–ø—Ä–æ—Å 2: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞**

–ü—Ä–µ–¥–ª–∞–≥–∞—é —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É:

```
uma/
‚îú‚îÄ‚îÄ __init__.py              # Public API
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ types.py            # EntityName, Operation, Protocols
‚îÇ   ‚îú‚îÄ‚îÄ context.py          # UMAContext
‚îÇ   ‚îú‚îÄ‚îÄ exceptions.py       # UmaError, UmaAccessDeniedError, etc.
‚îÇ   ‚îî‚îÄ‚îÄ utils.py            # parse_entity_name, form_entity_name, copy_field_meta
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ base.py             # DefaultEntityHandler
‚îÇ   ‚îî‚îÄ‚îÄ virtual.py          # VirtualViewHandler
‚îú‚îÄ‚îÄ registry.py              # EntityRegistry
‚îú‚îÄ‚îÄ metadata.py              # DefaultMetadataProvider
‚îî‚îÄ‚îÄ api.py                   # uma_select, uma_read, uma_save, etc.
```

**–í–æ–ø—Ä–æ—Å 3: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ Context –≤ –ø—Ä–æ–µ–∫—Ç–∞—Ö**

–î–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è `UMAContext` –≤ –ø—Ä–æ–µ–∫—Ç–∞—Ö –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

```python
# –í –ø—Ä–æ–µ–∫—Ç–µ
class ProjectContext(UMAContext):
    project_config: Any = None
    custom_cache: Any = None

# –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
context = ProjectContext(
    engine=engine,
    metadata=metadata,
    metadata_provider=provider,
    project_config=my_config
)
```

–í—Å–µ –º–µ—Ç–æ–¥—ã handlers –±—É–¥—É—Ç –ø–æ–ª—É—á–∞—Ç—å —ç—Ç–æ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç.

**–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã**

–í–æ–∑–º–æ–∂–Ω–æ, –±—É–¥—É—Ç –ø–æ–ª–µ–∑–Ω—ã:

```python
async def get_entity_metadata(
    entity_name: str | EntityName,
    context: UMAContext
) -> dict:
    """
    –£–¥–æ–±–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –ø—Ä—è–º–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ handler.
    """
    if isinstance(entity_name, str):
        entity_name = parse_entity_name(entity_name)
    
    registry = get_global_registry()
    handler = registry.get_handler(entity_name, context)
    return await handler.meta(entity_name, context)
```

–ì–æ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É. –ù–∞—á–∏–Ω–∞—Ç—å —Å —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –∫–æ–¥–∞?

